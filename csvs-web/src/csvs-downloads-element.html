<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<dom-module name="csvs-downloads-element">
    <style is="custom-style"
           include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">

        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            width: 100%;
        }
        .main{
            background-color: white;
            margin-right:auto;
            margin-left:auto;
            border-radius: 5px;
            padding: 1.5em;
            width: 80%;
            max-width: 850px;
            margin-top:15px;
            height: 100%;
            overflow-y:auto;
            overflow-x:auto;
        }
        .paragraph {
            font-size: 14px;
        }
        .label_downloads{
            width: 20%;
            padding-left:2.5em;
        }
        .version_file{
            float:left;
        }
        .block_label{
            margin-top: 15px;
        }
        .block_email{
            margin-left: 5%;
        }
        .input_downloads{
            width: 60%;
        }
        a{
            text-decoration: underline;
        }
        .ok {
            color: green;
        }

    </style>
    <template>
        <div class="vertical layout center-justified">
            <div  class="vertical main">
                <div class="paragraph">
                    Here you can download data corresponding to phenotypically healthy controls.<br/>
                    Datasets are downloaded as tab-delimited text files.
                </div>
                <br/>
                <label class="stv-control">
                    <input type="radio" id="Healthy" name="fileDownload" on-change="changeRadio" checked="checked" value="Healthy">
                    <span>Healthy controls</span>
                </label>
                </label>
                <div class="vertical layout block_email"  >
                    <div class="flex block_label" >
                        <label class="stv label_downloads">Name:*</label>
                        <input class="input_downloads" type="text" id="name_downloads" value="{{name_downloads::input}}" required/>
                    </div>
                    <div class="flex block_label">
                        <label class="stv label_downloads">Affiliation:*</label>
                        <input class="input_downloads" type="text" id="affiliation_downloads" value="{{affiliation_downloads::input}}" required/>
                    </div>
                    <div class="flex block_label">
                        <label class="stv label_downloads">Email:*</label>
                        <input  class="input_downloads" type="text" id="email_downloads" value="{{email_downloads::input}}" placeholder="example@example.com" required/>
                    </div>
                </div>
                <br/>
                <label class="stv-control">
                    <input type="checkbox" id="conditions">
                    <span>Check here to indicate that you have read agree with the terms and conditions of use of this data described <a href="/downloads/{{file_conditions}}" target="_blank">here</a>.</span>
                </label>
                <br/>
                <div>
                    <div class="version_file"> <label class="stv">Version: {{version_file}}</label></div>
                    <div class="horizontal layout center end-justified " >
                        <div id="Sending_disease" hidden$="{{!sending}}">
                            <i class="fa fa-circle-o-notch fa-spin"></i> Downloading ...
                        </div>
                        <div id="message_donwload" class="ok">{{message_donwload}} &nbsp;</div>
                        <div class="stv-btn stv-btn-shdw stv-btn-big" on-click="email_disease_file">&nbsp; Download</div>
                    </div>
                </div>
            </div>
        </div>

    </template>
</dom-module>

<script>
    Polymer({
        is: 'csvs-downloads-element',
        properties: {
            sending: {
                type: Boolean,
                value: false
            },
            name_downloads:{
                type: String,
                value: ""
            },
            affiliation_downloads:{
                type: String,
                value: ""
            },
            email_downloads: {
                type: String,
                value: ""
            },
            message_donwload:{
                type: String,
                value: ""
            },
            version_file:{
                type: String,
                value: ""
            },
            file_conditions:{
                type:String,
                value: "TermsAndConditions.pdf"
            }
        },
        ready:function(){
          this.version_file = window.VERSION_FILE;
        },
        email_disease_file: function () {
            var me = this;
            var msj = "";
            me.message_donwload = "";

            // Check empty and format
            if ($('[name="fileDownload"]:checked').length == 0) {
                msj = 'Please, selected a dataset to download. ';
            }
            if (_.isEmpty(me.$.name_downloads.value)) {
                msj = msj + 'Please, add your name. ';
            }

            if (_.isEmpty(me.$.affiliation_downloads.value)) {
                msj = msj + 'Please, add your affiliation. ';
            }
            if (!_.isEmpty(me.$.email_downloads.value)) {
                if (!/^(?:[^<>()[\].,;:\s@"]+(\.[^<>()[\].,;:\s@"]+)*|"[^\n"]+")@(?:[^<>()[\].,;:\s@"]+\.)+[^<>()[\]\.,;:\s@"]{2,63}$/i.test(me.$.email_downloads.value)) {
                    msj = msj + 'Invalid email format. ';
                }
            } else {
                msj = msj + 'Please, add your email. '
            }
            if (!$('#conditions').is(':checked')) {
                msj = msj + 'Please, check to indicate that you have read your agree with the terms and conditions. ';
            }


            if (msj != "") {
                new StvDialog().alert(msj);
            } else {
                // Downloads
                me.sending = true;
                var disease = $('[name="fileDownload"]:checked').val();
                var url = window.CSVS_HOST + "/download/" +  disease || "";

                var text = ' Name: ' + me.$.name_downloads.value + '<br/>' +
                    ' Affiliation: ' + me.$.affiliation_downloads.value + '<br/>' +
                    ' Email: ' + me.$.email_downloads.value + '<br/>' +
                    ' File Download: ' + $.trim($('[name="fileDownload"]:checked').parent().text());

                var acronym = "(" + window.ACRONYM_APP + ")" || '';
                $.ajax({
                    url: url,
                    data: {
                        disease: disease,
                        subject: 'Download file '+ acronym+ ': ' + $('[name="fileDownload"]:checked').val(),
                        text: text,
                        html: '<pre>' + text + '</pre>',
                        from: window.FROM_EMAIL || '',
                        to: window.TO_EMAIL || '',
                        host: window.HOST || '',
                        port: window.PORT || '',
                        secure: window.SECURE,
                        debug: window.DEBUG,
                        ignoreTLS: window.IGNORE_TLS,
                        user: window.USER,
                        pass: window.PASS
                    },
                    crossDomain: true,
                    success: function (data) {
                        if (data) {
                            var dataJSON;
                            if (/^{"data":{/.test(data)) {
                                dataJSON = JSON.parse(data);
                            }

                            // Download datas from file
                            if (dataJSON == undefined) {
                                var link = document.createElement('a');
                                link.name="tmpDownload";
                                document.body.appendChild(link);
                                var blob = new Blob([data], {type: 'application/csv'});
                                link.href = window.URL.createObjectURL(blob);
                                link.download = $('[name="fileDownload"]:checked').val() + ".csv";
                                link.click();
                                document.body.removeChild(link);

                                me.sending = false;
                                me.message_donwload = 'Download done!';
                                document.getElementById("message_donwload").style = "color:green";
                            } else {
                                // Donwload  url
                                if (dataJSON['data']['url'] != undefined) {
                                    window.open('/downloads/' + dataJSON["data"]["url"], "_blank");

                                    me.sending = false;
                                    me.message_donwload = 'Download done!';
                                    document.getElementById("message_donwload").style = "color:green";
                                } else {
                                    // Error to download
                                    me.sending = false;
                                    new StvDialog().alert('There has been a problem with the server, try again later');
                                    console.log("CSVS: Problems with file download");
                                }
                            }
                        } else {
                            me.sending = false;
                            new StvDialog().alert('There has been a problem with the server, try again later');
                            console.log('CSVS: Problems with the server when send info');
                        }
                    },
                    error: function (jqXHR, exception) {
                        me.sending = false;
                        new StvDialog().alert('There has been a problem with the server, try again later');
                        console.log('CSVS: Fail download ' + disease + ' from ' + url + '   ');
                    },
                    type: "POST"
                }); // End ajax

            }
        },
        changeRadio: function (){
            this.message_donwload = "";
        }
    });
</script>