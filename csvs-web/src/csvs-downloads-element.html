<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<dom-module name="csvs-downloads-element">
    <style is="custom-style"
           include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">

        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            width: 100%;
        }
        .main{
            background-color: white;
            margin-right:auto;
            margin-left:auto;
            border: 1px groove gray;
            border-radius: 5px;
            padding: 1.5em;
            width: 80%;
            max-width: 780px;
            margin-top:15px;
            height: 100%;
            overflow-y:auto;
            overflow-x:auto;
        }
        .paragraph {
            font-size: 14px;
        }
        .label_downloads{
            width: 20%;
            padding-left:2.5em;
        }
        .input_downloads{
            width: 60%;
        }
        a{
            text-decoration: underline;
        }
        .ok {
            color: green;
        }

    </style>
    <template>
        <div class="vertical layout center-justified">
            <div  class="vertical main">
                <div class="paragraph">
                    Here you can download aggregated data corresponding to phenotypically healthy controls
                    of MGP and the IBS population of 1000 genomes phase 3 as well as the pseudo-controls for each ICD10 category made with
                    all the samples except each specific ICD10 disease category.
                    Datasets are downloaded as tab-delimited text files.
                    Select dataset to download:
                </div>
                <br/>
                <label class="stv-control">
                    <input type="radio" id="all" name="fileDownload" on-change="changeRadio" value="all">
                    <span>All</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="MGP" name="fileDownload" on-change="changeRadio" value="MGP">
                     <span>MGP controls</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="MGPandIBS" name="fileDownload" on-change="changeRadio" value="MGPandIBS">
                    <span>MGP + IBS controls</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group1" name="fileDownload" on-change="changeRadio" value="all_less_group1">
                    <span>All individual except ICD10 group I: Certain infectious and parasitic diseases</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group2" name="fileDownload" on-change="changeRadio" value="all_less_group2">
                    <span>All individual except ICD10 group II: Neoplasms</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group3" name="fileDownload" on-change="changeRadio" value="all_less_group3">
                    <span>All individual except ICD10 group III: Diseases of the blood and blood-forming organs and certain disorders involving the immune mechanism</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group4" name="fileDownload" on-change="changeRadio" value="all_less_group4">
                    <span>All individual except ICD10 group IV: Endocrine, nutritional and metabolic diseases</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group5" name="fileDownload" on-change="changeRadio" value="all_less_group5">
                    <span>All individual except ICD10 group V: Mental and behavioural disorders</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group6" name="fileDownload" on-change="changeRadio" value="all_less_group6">
                    <span>All individual except ICD10 group VI: Diseases of the nervous system</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group7" name="fileDownload" on-change="changeRadio" value="all_less_group7">
                    <span>All individual except ICD10 group VII: Diseases of the eye and adnexa</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group8" name="fileDownload" on-change="changeRadio" value="all_less_group8">
                    <span>All individual except ICD10 group VIII: Diseases of the ear and mastoid process</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group9" name="fileDownload" on-change="changeRadio" value="all_less_group9">
                    <span>All individual except ICD10 group IX: Diseases of the circulatory system</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group10" name="fileDownload" on-change="changeRadio" value="all_less_group10">
                    <span>All individual except ICD10 group X: Diseases of the respiratory system</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group11" name="fileDownload" on-change="changeRadio" value="all_less_group11">
                    <span>All individual except ICD10 group XI: Diseases of the digestive system</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group12" name="fileDownload" on-change="changeRadio" value="all_less_group12">
                    <span>All individual except ICD10 group XII: Diseases of the skin and subcutaneous tissue</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group13" name="fileDownload" on-change="changeRadio" value="all_less_group13">
                    <span>All individual except ICD10 group XIII: Diseases of the musculoskeletal system and connective tissue</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group14" name="fileDownload" on-change="changeRadio" value="all_less_group14">
                    <span>All individual except ICD10 group XIV: Diseases of the genitourinary system</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group15" name="fileDownload" on-change="changeRadio" value="all_less_group15">
                    <span>All individual except ICD10 group XV: Pregnancy, childbirth and the puerperium</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group16" name="fileDownload" on-change="changeRadio" value="all_less_group16">
                    <span>All individual except ICD10 group XVI: Certain conditions originating in the perinatal period</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group17" name="fileDownload" on-change="changeRadio" value="all_less_group17">
                    <span>All individual except ICD10 group XVII: Congenital malformations, deformations and chromosomal abnormalities</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group18" name="fileDownload" on-change="changeRadio" value="all_less_group18">
                    <span>All individual except ICD10 group XVIII: Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group19" name="fileDownload" on-change="changeRadio" value="all_less_group19">
                    <span>All individual except ICD10 group XIX: Injury, poisoning and certain other consequences of external causes</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group20" name="fileDownload" on-change="changeRadio" value="all_less_group20">
                    <span>All individual except ICD10 group XX: External causes of morbidity and mortality</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group21" name="fileDownload" on-change="changeRadio" value="all_less_group21">
                    <span>All individual except ICD10 group XXI: Factors influencing health status and contact with health services</span>
                </label>
                <label class="stv-control">
                    <input type="radio" id="all_less_group22" name="fileDownload" on-change="changeRadio" value="all_less_group22">
                    <span>All individual except ICD10 group XXII: Codes for special purposes</span>
                </label>
                <br/>
                <div class="vertical layout" style="margin-top: 15px;">
                    <div class="flex">
                        <label class="stv label_downloads">Name:*</label>
                        <input class="input_downloads" type="text" id="name_downloads" value="{{name_downloads::input}}" required/>
                    </div>
                    <br/>
                    <div class="flex">
                        <label class="stv label_downloads">Affiliation:*</label>
                        <input class="input_downloads" type="text" id="affiliation_downloads" value="{{affiliation_downloads::input}}" required/>
                    </div>
                    <br/>
                    <div class="flex">
                        <label class="stv label_downloads">Email:*</label>
                        <input  class="input_downloads" type="text" id="email_downloads" value="{{email_downloads::input}}" placeholder="example@example.com" required/>
                    </div>
                </div>
                <br/>
                <label class="stv-control">
                    <input type="checkbox" id="conditions">
                    <span>Check here to indicate that you have read agree with the terms and conditions of use of this data described <a href="../CSVSTermsAndConditions.pdf" target="_blank">here</a>.</span>
                </label>
                <br/>
                <div class="horizontal layout center end-justified">
                    <div id="Sending_disease" hidden$="{{!sending}}">
                        <i class="fa fa-circle-o-notch fa-spin"></i> Sending...
                    </div>
                    <div id="message_donwload" class="ok">{{message_donwload}} &nbsp;</div>
                    <div class="stv-btn stv-btn-shdw stv-btn-big" on-click="email_disease_file">&nbsp; Download</div>
                </div>
            </div>
        </div>

    </template>
</dom-module>

<script>
    Polymer({
        is: 'csvs-downloads-element',
        properties: {
            sending: {
                type: Boolean,
                value: false
            },
            name_downloads:{
                type: String,
                value: ""
            },
            affiliation_downloads:{
                type: String,
                value: ""
            },
            email_downloads: {
                type: String,
                value: ""
            },
            message_donwload:{
                type: String,
                value: ""
            }
        },
        email_disease_file: function () {
            var me = this;
            var msj = "";
            me.message_donwload = "";

            // Check empty and format
            if ($('[name="fileDownload"]:checked').length == 0) {
                msj = 'Please, selected a dataset to download. ';
            }
            if (_.isEmpty(me.$.name_downloads.value)) {
                msj = msj + 'Please, add your name. ';
            }

            if (_.isEmpty(me.$.affiliation_downloads.value)) {
                msj = msj + 'Please, add your affiliation. ';
            }
            if (!_.isEmpty(me.$.email_downloads.value)) {
                if (!/^(?:[^<>()[\].,;:\s@"]+(\.[^<>()[\].,;:\s@"]+)*|"[^\n"]+")@(?:[^<>()[\].,;:\s@"]+\.)+[^<>()[\]\.,;:\s@"]{2,63}$/i.test(me.$.email_downloads.value)) {
                    msj = msj + 'Invalid email format. ';
                }
            } else {
                msj = msj + 'Please, add your email. '
            }
            if (!$('#conditions').is(':checked')) {
                msj = msj + 'Please, check to indicate that you have read your agree with the terms and conditions. ';
            }


            if (msj != "") {
                new StvDialog().alert(msj);
            } else {
                // Downloads
                me.sending = true;
                var disease = $('[name="fileDownload"]:checked').val();
                var url = window.CSVS_DOWNLOAD + disease || ""; // window.CSVS_DOWNLOAD + disease;

                var text = ' Name: ' + me.$.name_downloads.value + '<br/>' +
                    ' Affiliation: ' + me.$.affiliation_downloads.value + '<br/>' +
                    ' Email: ' + me.$.email_downloads.value + '<br/>' +
                    ' File Download: ' + $.trim($('[name="fileDownload"]:checked').parent().text());

                $.ajax({
                    url: url,
                    data: {
                        disease: disease,
                        subject: 'Download file: ' + $('[name="fileDownload"]:checked').val(),
                        text: text,
                        html: '<pre>' + text + '</pre>',
                        from: window.FROM_EMAIL || '',
                        to: window.TO_EMAIL || '',
                        host: window.HOST || '',
                        port: window.PORT || '',
                        secure: window.SECURE,
                        debug: window.DEBUG,
                        ignoreTLS: window.IGNORE_TLS,
                        user: window.USER,
                        pass: window.PASS
                    },
                    crossDomain: true,
                    success: function (data) {
                        if (data) {
                            if (data["error"] == undefined) {
                                // Download data
                                var blob = new Blob([data], {type: 'application/csv'});
                                var link = document.createElement('a');
                                link.href = window.URL.createObjectURL(blob);
                                link.download = $('[name="fileDownload"]:checked').val() + ".csv";
                                link.click();

                                // Show message
                                me.sending = false;
                                me.message_donwload = 'Download done!';
                                document.getElementById("message_donwload").style = "color:green";
                            } else {
                                me.sending = false;
                                new StvDialog().alert('There has been a problem with the server, try again later');
                                console.log("CSVS: (File Download)  " + data.error);
                            }
                        } else {
                            me.sending = false;
                            new StvDialog().alert('There has been a problem with the server, try again later');
                            console.log('CSVS: Problems with the server when send info');
                        }
                    },
                    error: function (jqXHR, exception) {

                        var msg = '';
                        if (jqXHR.status === 0) {
                            msg = 'Not connect.\n Verify Network.';
                        } else if (jqXHR.status == 404) {
                            msg = 'Requested page not found. [404]';
                        } else if (jqXHR.status == 500) {
                            msg = 'Internal Server Error [500].';
                        } else if (exception === 'parsererror') {
                            msg = 'Requested JSON parse failed.';
                        } else if (exception === 'timeout') {
                            msg = 'Time out error.';
                        } else if (exception === 'abort') {
                            msg = 'Ajax request aborted.';
                        } else {
                            msg = 'Uncaught Error.\n' + jqXHR.responseText;
                        }
                        me.sending = false;
                        new StvDialog().alert('There has been a problem with the server, try again later');
                        console.log('CSVS: Fail download ' + disease + ' from ' + url + '   ' + msg);
                    },
                    type: "POST"
                }); // End ajax

            }
        },
        changeRadio: function (){
            this.message_donwload = "";
        }
    });
</script>