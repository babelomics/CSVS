<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/jsorolla/src/lib/components/jso-genome-viewer-element.html">

<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-position.html">
<link rel="import" href="./csvs-filter-consequencetypes.html">
<link rel="import" href="../bower_components/stevia-elements/src/stv-tooltip.html">

<script src="../bower_components/stevia-elements/src/manager/cellbase-manager.js"></script>
<script src="./manager/csvs-manager.js"></script>
<script src="./manager/ws-manager.js"></script>

<link rel="import" href="./csvs-table-saturation.html">

<link rel="import" href="csvs-saturation-element.html">


<link rel="import" href="csvs-contact-request.html">

<dom-module id="csvs-search-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            background-color: var(--text-primary-color);
            color: var(--primary-text-color);
        }

        #filter-form-element {
            background-color: #FFFFFF;
            width: 250px;
            margin: 20px;
            min-height: 900px;
        }

        textarea {
            resize: none;
        }

        .searchGene {
            margin-top: 5px;
        }

        #dataGridElement {
            border-radius: 0px !important;
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 290px);
        }

        #saturationDiv, .saturatDiv {
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 29em);
            padding: 0em 4em;
        }

        .container> span {
            margin-left: 10px;
        }

        .stv-form-box {
            width: 250px;
            ;
        }

        #diseases_div
        {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }

        #technologies_div {
            height: 50px;
            max-height: 50px;
            width: 225px;
            overflow-y: auto;
        }
        #highlights_div{
            height: 550px;
            max-height: 550px;
            width: 225px;
            overflow-y: auto;
        }

        #exportBtn {
            height: 20px;
        }

        #dataTable {
            font-size: 11px;
        }

        stv-table {
            overflow-y: auto;
        }

        stv-table::shadow #list {
            height: 300px;
            overflow-x: auto
        }

        stv-table::shadow {
            font-size: 11px;
        }

        #menu {
            margin-top: 15px;
        }

        #menu> div {
            font-size: 17px;
            padding: 5px 5px;
            margin: 0 20px;
            border-bottom: 2px solid transparent;
            transition: all 0.1s;
            cursor: pointer;
        }

        #menu> div:hover {
            border-bottom-color: rgba(125, 125, 125, 0.4);
        }

        #menu> div[selected] {
            border-bottom-color: rgba(125, 125, 125, 0.7);
        }

        #tools {
            margin-top: 10px;
        }

        .tool {
            min-height: 1000px;
            width: 100%;
        }

        jso-genome-viewer-element,
        #dataTable {
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
        }

        stv-form-box {
            min-width: 240px;
        }

        #dataTable {
            border: 1px solid var(--divider-color)
        }

        stv-tooltip::shadow #messageInfo::shadow {
            height: 300px;
            width: 500px;
            background-color: #e2e9e9;
            border: 1px solid #e2e9e9;
            color: black;
            font-style: normal;
        }

        stv-tooltip::shadow .closeInfo::shadow {
            margin-left: 490px;
        }

        .tit {
            margin-top: 10px;
            border-bottom: 1px solid #445D76;
            font-weight: bold;
        }

        .name {
            width: 300px;
        }

        .num {
            width: 100px;
        }

        .clear-but {
            width: 100px;
            background-color: #f0f4f4 !important;
        }

        #filterHistoryTable> div:hover {
            background-color: #8ba7a7;
            border: 1px solid #8ba7a7;
        }

        #filter-name {
            text-overflow: ellipsis;
            width: 300px;
            white-space: nowrap;
            overflow: hidden;
        }

        .check {
            cursor: pointer;
            color: var(--secondary-text-color);
            padding-right: 2px;
        }

        .check:hover {
            color: var(--accent-color);
            font-weight: bold;
        }

        .titleCategory{
            background-color: #f0f0f0;
        }
    </style>
    <template>
        <div class="horizontal layout">
            <div id="filter-form-element">
                <form id="filter_form" class="vertical layout">
                    <div class="vertical layout">
                        <div id="buttons_container" class="horizontal layout end-justified" style="margin:10px 5px;">
                            <!-- <stv-tooltip id="filterHistoryTooltip" class="stv-btn stv-btn-shdw" title="Filters History" icon="filter" style="margin-right: 3px;">
                                <div class="stv-btn stv-btn-shdw clear-but" title="Clear Filters History" on-click="clearFiltersHistory">
                                    Clear
                                </div>
                                <div class="horizontal layout flex">
                                    <span class="tit num"> Date </span>
                                    <span class="name tit"> Name </span>
                                    <span class="tit num"> Found</span>
                                </div>
                                <div id="filterHistoryTable">
                                    <template is="dom-repeat" items="{{historyFilters}}">
                                        <div class="horizontal layout flex" on-click="loadFilter" data-filter="{{item.filter}}" title="{{item.name}}">
                                            <span class="num">{{item.date}} </span>
                                            <span id="filter-name" class="name">{{item.name}} </span>
                                            <span class="num">{{item.found}}</span>
                                        </div>
                                    </template>
                                </div>
                            </stv-tooltip> -->
                            <div class="stv-btn stv-btn-shdw flex" on-click="clearForm" style="margin-right: 3px;">
                                Clear
                            </div>
                            <div class="stv-btn stv-btn-shdw flex" on-click="submitForm">Search</div>
                        </div>

                        <stv-filter-position id="filterPosition"></stv-filter-position>
                        <stv-form-box>
                            <div class="header horizontal layout flex">
                                <div>Subpopulations</div>
                                <div class="flex"></div>
                                <div on-click="selectAllDiseases" title="Select all subpopulations">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllDiseases" title="Deselect all subpopulations">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="diseases_div">
                                    <template is="dom-repeat" items="{{diseases}}">
                                        <template is="dom-if" if="{{item.samples}}">
                                            <label class="stv-control">
                                                <input type="checkbox" class="diseaseName" name="disease" id="disease{{item.groupId}}" value="{{item.groupId}}" checked/>
                                                <span>{{item.name}}</span>
                                            </label>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </stv-form-box>
                        <stv-form-box>
                            <div class="header horizontal layout flex">
                                <div>Technologies</div>
                                <div class="flex"></div>
                                <div on-click="selectAllTechnologies" title="Deselect all technologies">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllTechnologies" title="Select all technologies">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="technologies_div">
                                    <template is="dom-repeat" items="{{technologies}}">
                                        <template is="dom-if" if="{{item.samples}}">
                                            <label class="stv-control">
                                                <input type="checkbox" class="technologyName" name="technology" id="technology{{item.technologyId}}" value="{{item.technologyId}}" checked/>
                                                <span>{{item.name}}</span>
                                            </label>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </stv-form-box>
                        <stv-form-box hidden$="{{saturation}}">
                            <div class="header horizontal layout flex">
                                <div>Highlights</div>
                                <div class="flex"></div>
                                <div on-click="selectAllHighlights" title="Select all Sequence Ontology terms">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllHighlights" title="Deselect all Sequence Ontology terms">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="highlights_div">
                                    <template is="dom-repeat" items="{{highlights}}" as="highlightGroup">
                                        <div>
                                            <label class="stv-control">
                                                <label class="stv"><span>{{highlightGroup.group}}:</span></label>
                                                <template is="dom-repeat" items="{{highlightGroup.groupValues}}" as="item">
                                                    <div style="padding-left: 15px; display:inline-block">
                                                        <span style="display:inline-block; width: 70px" title="{{item.description}}">{{item.title}} <sup><i class="fa fa-info-circle" style="color:#666" aria-hidden="true"></i></sup>:</span>
                                                        <select class="highlightsOp stv stv-btn" style="display:inline-flex;"
                                                                name="highlightOp" id="opc_{{item.name}}" key="{{item.name}}" value="{{item.op}}"  />
                                                        <template is="dom-repeat" items="{{item.ops}}" as="itemOp">
                                                            <option value="{{itemOp}}"> {{itemOp}} </option>
                                                        </template>
                                                        </select>
                                                        <input type="text" class="highlightsName stv" style="width: auto; display:inline" label="{{item.title}}"
                                                               name="highlight"  id="highlight_{{item.name}}" key="{{item.name}}" value="{{item.value}}" size="5" min="{{item.limit.min}}" max="{{item.limit.max}}"
                                                               inputmode="numeric" pattern="-?(0|([1-9]\d*))(\.\d+)?"
                                                        />
                                                    </div>
                                                </template>
                                            </label>
                                        </div>
                                    </template>

                                    <div>
                                        <csvs-consequencetypes id="highlightsConsequenceTypes" ></csvs-consequencetypes>
                                    </div>

                                </div>
                            </div>
                        </stv-form-box>


                    </div>
                </form>
            </div>
            <div id="dataGridElement" class="vertical layout" hidden$="{{saturation}}">
                <stv-table id="dataTable" enable-loading enable-paging enable-remote enable-select enable-resize request="{{request}}" columns="{{columns}}" on-rowclick="handleRowClick">
                    <div class="custom-buttons horizontal layout">
                        <button style="margin-right: 10px; color: #006699" id="saveTable" class="stv-btn down" on-click="downloadFiles" data-file="{{cnv}}"><i class="fa fa-cloud-download"></i> save</button>
                    </div>
                </stv-table>

                <div id="menu" class="color-2 color-hover-2 horizontal layout">
                    <div on-click="handleMenuClick" data-option="gv">Genomic context</div>
                    <div on-click="handleMenuClick" data-option="frequency">Frequencies</div>
                    <div on-click="handleMenuClick" data-option="phenotype">Phenotype</div>
                    <div on-click="handleMenuClick" data-option="effect">Effect</div>
                </div>

                <div id="tools" class="horizontal layout flex">
                    <jso-genome-viewer-element id="gv" class="tool" on-created="handleGenomeViewerCreated"></jso-genome-viewer-element>
                    <stv-variant-frequencies id="frequency" hidden class="tool"></stv-variant-frequencies>
                    <stv-variant-phenotype id="phenotype" hidden class="tool"></stv-variant-phenotype>
                    <stv-variant-effect id="effect" hidden class="tool"></stv-variant-effect>
                </div>
            </div>
            <div id="saturationDiv" hidden$="{{!saturation}}" class="vertical layout">
                <div id="chart" class="horizontal layout center-justified"  >
                </div>
                <div id=saturationDivTable" class="horizontal layout flex center-justified">
                    <csvs-table-saturation id="tvSaturation" ></csvs-table-saturation>
                </div>
            </div>
        </div>

    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-search-element',
        properties: {
            diseases: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: 'diseasesChanged'
            },
            technologies: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            highlights: {
                type: Array,
                value: function () {
                    return [{
                        group: "Deleteriousness",
                        groupValues: [
                            {
                                name: "sift",
                                title: "SIFT",
                                description: "SIFT score predicts whether an amino acid substitution affects protein function. SIFT value less than 0.05 represents a 'deleterious' prediction. SIFT value greater than or equal to 0.05 represents a 'tolerated' prediction.",
                                op: "<",
                                value: "0.05",
                                defaultValue: "0.05",
                                defaultOp: "<",
                                ops :["<","<="],
                                limit:{
                                    min: 0,
                                    max: 1
                                }
                            },
                            {
                                name: "polyphen",
                                title: "Polyphen",
                                description: "Polyphen score predicts the possible impact of an aninoacid subsitution on the structure and function of a protein. Polyphen scores can be benign (<0.446), possibly damaging (0.446-0.908) or probably damaging (>0.908).",
                                op: ">",
                                value: "0.91",
                                defaultValue: "0.91",
                                defaultOp: ">",
                                ops :[">", ">="],
                                limit:{
                                    min: 0,
                                    max: 1
                                }
                            },
                            {
                                name: "cadd",
                                title: "CADD",
                                description: "CADD tool scores the deleteriousness of snvs and indels. Higher values indicate more likely to have deleterious effects.",
                                op: ">",
                                value: "15",
                                defaultValue: "15",
                                defaultOp: ">",
                                ops :[">",">="]
                            }
                        ]
                    },
                        {
                            group: "Conservation",
                            groupValues: [
                                {
                                    name: "gerp",
                                    title: "GERP",
                                    description: "GERP score estimates the level of conservation of positions. Positive scores represents a substitution deficit and this indicate that a site may be under evolutionary constraint. Negative scores indicate that a site is probably evolving neutrally. Some author suggest that scores >=2 indicate evolutionary constraint and >=3 indicate purifying selection.",
                                    op: ">",
                                    value: "2",
                                    defaultValue: "2",
                                    defaultOp: ">",
                                    ops :[">", ">="],
                                    limit:{
                                        min: -15,
                                        max: 7
                                    }
                                }]
                        },
                    ]
                }
            },
            highlightsSO: {
                type: Object,
                value: function() {
                    return {
                            group:"SO terms",
                            name: "ct",
                            values:[],
                            groupValues:[
                                { category: "Integenic", ops: [
                                    { name: "upstream_gene_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:28},
                                    { name: "2KB_upstream_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:26},
                                    { name: "downstream_gene_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:29},
                                    { name: "2KB_downstream_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:27},
                                    { name: "intergenic_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:38},
                                    { name: "downstream_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:29},
                                    { name: "upstream_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:28} ]},
                                { category: "Regulatory", ops: [
                                    { name: "mature_miRNA_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:19},
                                    { name: "regulatory_region_ablation", impact: "MODIFIER", checked: true, defaultChecked: true, order:33},
                                    { name: "regulatory_region_amplification", impact: "MODIFIER", checked: true, defaultChecked: true, order:34},
                                    { name: "regulatory_region_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:36},
                                    { name: "TF_binding_site_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:32},
                                    { name: "TFBS_ablation",	impact: "MODIFIER", checked: true, defaultChecked: true, order:30},
                                    { name: "TFBS_amplification",	impact: "MODIFIER", checked: true, defaultChecked: true, order:31}] },
                                { category: "Coding", ops: [
                                    { name: "coding_sequence_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:18},
                                    { name: "feature_elongation",	impact: "MODIFIER", checked: true, defaultChecked: true, order:35},
                                    { name: "feature_truncation",	impact: "MODIFIER",checked: true,  defaultChecked: true, order:37},
                                    { name: "frameshift_variant",	impact: "HIGH" , checked: true, defaultChecked: true, order:5},
                                    { name: "incomplete_terminal_codon_variant",	impact: "LOW", checked: true, defaultChecked: true, order:14},
                                    { name: "inframe_deletion", impact: "MODERATE", checked: true, defaultChecked: true, order:10},
                                    { name: "inframe_insertion",	impact: "MODERATE", checked: true, defaultChecked: true, order:9},
                                    { name: "missense_variant", impact: "MODERATE", checked: true, defaultChecked: true, order:11 },
                                    { name: "NMD_transcript_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:24},
                                    { name: "protein_altering_variant", impact: "MODERATE", checked: true, defaultChecked: true, order:12},
                                    { name: "synonymous_variant",	impact: "LOW", checked: true, defaultChecked: true, order:17},
                                    { name: "start_lost", impact: "HIGH", checked: true, defaultChecked: true, order:7},
                                    { name: "stop_retained_variant", impact: "LOW", checked: true, defaultChecked: true, order:16 },
                                    { name: "stop_gained", impact: "HIGH", checked: true, defaultChecked: true, order:4},
                                    { name: "stop_lost", impact: "HIGH", checked: true, defaultChecked: true, order:6},
                                    { name: "start_retained_variant",	impact: "LOW", checked: true, defaultChecked: true, order:15}] },
                                { category: "No coding", ops: [
                                    { name: "3_prime_UTR_variant", impact: "MODIFIER",checked: true, defaultChecked: true, order:21},
                                    { name: "5_prime_UTR_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:20},
                                    { name: "intron_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:23},
                                    { name: "non_coding_transcript_exon_variant", impact: "MODIFIER",checked: true, defaultChecked: true, order:22},
                                    { name: "non_coding_transcript_variant", impact: "MODIFIER", checked: true, defaultChecked: true, order:25}] },
                                { category: "Slice", ops: [
                                    { name: "splice_acceptor_variant", impact: "HIGH", checked: true, defaultChecked: true, order:2},
                                    { name: "splice_donor_variant", impact: "HIGH", checked: true, defaultChecked: true, order:3},
                                    { name: "splice_region_variant", impact: "LOW", checked: true, defaultChecked: true, order:13}]},
                                { ops: [ {name: "transcript_ablation" , impact: "HIGH", checked: true, defaultChecked: true, order:1}]},
                                { ops: [ {name: "transcript_amplification" , impact: "HIGH", checked: true, defaultChecked: true, order:8}]},
                            ]
                        }
                },
            },
            regionValue: {
                type: String,
                value: ""
            },
            columns: {
                type: Array,
                value: function() {
                    return [];
                },
            },
            formURL: {
                type: String,
                value: "",
                observer: 'urlChanged'
            },
            floatDecimals: {
                type: Number,
                value: 3
            },

            selectedMenuTool: {
                type: Object,
                observer: 'selectedMenuChanged'
            },
            geneValue: {
                type: String,
                value: ""
            },
            hidden: {
                type: Boolean,
                reflectToAttribute: true,
                observer: 'hiddenChanged',
                nofity: true
            },
            maxLength: {
                type: Number,
                value: 1000000
            },
            isLogged: {
                type: Boolean
            },
            historyFilters: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,

            },
            numTotalResults: {
                type: Object,
                observer: "resultsChanged"
            },
            query: {
                type: Object,
                notify: true,
                value: function() {
                    return {};
                }
            },
            saturation: {
                type: Boolean,
                value: false,
                observer: "saturationChanged"
            },
            loadingSaturation:{
                type: Boolean,
                value: false
            }
        },
        listeners: {  // when open popup
            "disablescroll": 'disableScroll',
            "enablescroll": 'enableScroll',
            "getDataSearch": 'getDataSearch'
        },

        saturationChanged: function(){
            // Check if tab is changed and reload info
            this.submitForm();
        },
        resultsChanged: function(neo, old) {
            return;
            if (neo != -1) {
                var query = this.query;
                var numTotalResults = neo;
                /* Filter History */

                var newFilter = JSON.stringify(query);
                var _load = -1;
                for (var i = 0; i < this.historyFilters.length && _load == -1; i++) { // Check if the fitler has been selected from the history
                    var elem = this.historyFilters[i];
                    if (elem != null) {
                        var oldFilter = JSON.stringify(this.historyFilters[i].filter);
                        if (newFilter == oldFilter) {
                            _load = i;
                        }
                    }
                }

                if (_load == -1) { // This filter is new (has not been selected from the history)
                    if (query.regions != null && query.diseases != null) {
                        var dateAux = new Date();
                        var minAux = dateAux.getMinutes();
                        if (minAux < 10) {
                            minAux = "0" + minAux;
                        }
                        var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;
                        name = this.loadForm(query);
                        var found = numTotalResults;
                        var hf = {};
                        hf = {
                            date: date,
                            name: name,
                            filter: query,
                            found: found
                        };

                        var filters = new FilterHistory(5, this.historyFilters);
                        filters.unshift(hf);
                        this.set("historyFilters", filters);

                        localStorage.csvs_filter_history = JSON.stringify(this.historyFilters);
                    }
                } else { // HistoryFilter contains this filter. We need to change the date and push to top
                    var pos = _load;

                    var filters = new FilterHistory(5, this.historyFilters);
                    var filter = filters[pos];
                    var dateAux = new Date();
                    var minAux = dateAux.getMinutes();
                    if (minAux < 10) {
                        minAux = "0" + minAux;
                    }
                    var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;

                    filter.date = date;

                    var aux = filters[pos];
                    filters[pos] = filters[0];
                    filters[0] = aux;

                    this.set("historyFilters", filters);
                    localStorage.csvs_filter_history = JSON.stringify(this.historyFilters);
                }
            }

        },

        geneChanged: function(e) {
            var target = e.currentTarget;
            var value = target.value;
            var splits = value.split(",");
            if (splits.length > 3 && !this.isLogged) {
                new StvDialog().alert("The maximum number of genes is 3");
            }
        },
        hiddenChanged: function(neo, old) {

            if (!neo && this.selectedMenuTool) {
                this.$.gv.removeAttribute("hidden");
            }
        },
        created: function() {
            this.selectedSpecies = DEFAULT_SPECIES;
        },

        _getStyleFormula: function(row, field) {
            var style = {};

            var obj = null;
            if (row != undefined && row != null) {
                for (var i = 0; i < this.highlights.length && obj == null; i++) {
                    obj = !!this.highlights[i].groupValues && this.highlights[i].groupValues.find(h  => h.name === field);
                }

                if (obj != null && obj != undefined && !!row && !!obj.value) {
                    if (eval(row + " " + obj.op + " " + obj.value)) {
                        style.color = '#fff';
                        style.backgroundColor = '#f47070';
                    }
                }
            }
            return style;
        },

        getColor: function(impact){

            switch(impact){
                case "HIGH":
                    return  "red";

                case "MODERATE":
                    return "#ED760E";

                case "LOW":
                    return "blue";

                case "MODIFIER":
                    return "green";

                default:
                    return "grey";
            }
        },

        _getStyleFormulaConsequence: function(row, field){
            var style = {};

            var obj = null;

            for (var i = 0; i < this.highlightsSO.groupValues.length && obj == null ; i++) {
                if ("category" in this.highlightsSO.groupValues[i]) {
                    obj = this.highlightsSO.groupValues[i].ops.find(h => h.name === row && h.checked);
                } else {
                     obj = this.highlightsSO.groupValues[i].ops.find(h => h.name === row && h.checked);
                }
            }

            if (obj != null && obj!= undefined && !!row){
                style.color = this.getColor(obj.impact);
            }
            return style;
        },

        handleHighlights: function(){
            var msj = "";
            var highlightsNameValue = this.$.highlights_div.querySelectorAll(".highlightsName");
            var highlightsOpValue = this.$.highlights_div.querySelectorAll(".highlightsOp");

            var  pos = 0;
            for (var i = 0; i < this.highlights.length && highlightsNameValue.length ; i++) {
                for (var j = 0; j < this.highlights[i].groupValues.length ; j++) {
                        if (highlightsNameValue[pos].value !=""){
                            if (!/^-?\d{1,9}(\.\d{1,2})?$/.test(highlightsNameValue[pos].value)) {
                                msj = msj + "Format incorrect: '" +  this.highlights[i].groupValues[j].title + " " +  highlightsOpValue[pos].value + " " + highlightsNameValue[pos].value + "'\n";
                            } else {
                                if (!!this.highlights[i].groupValues[j].limit)
                                    if ((this.highlights[i].groupValues[j].limit.min != undefined && this.highlights[i].groupValues[j].limit.min > parseFloat(highlightsNameValue[pos].value)) ||
                                        (this.highlights[i].groupValues[j].limit.max != undefined  && this.highlights[i].groupValues[j].limit.max < parseFloat(highlightsNameValue[pos].value)))
                                        {
                                            msj = msj + "Out of range in '" + this.highlights[i].groupValues[j].title + " " +  highlightsOpValue[pos].value + " " + highlightsNameValue[pos].value + "'"
                                                + ": Allowed values are between '"+this.highlights[i].groupValues[j].limit.min+"' and '"+this.highlights[i].groupValues[j].limit.max+"'\n";
                                        }
                            }
                        }

                        this.highlights[i].groupValues[j].value = highlightsNameValue[pos].value;
                        this.highlights[i].groupValues[j].op = highlightsOpValue[pos].value;
                        pos++;
                }
            }
            if (msj != ""){
                new StvDialog().alert("Highlights: \n" + msj);
                return
            }

            var highlightsSOChecked = this.$.highlights_div.querySelectorAll(".highlightSOName");

            highlightsSOChecked.forEach(
                hc =>{

                for (var i = 0; i < this.highlightsSO.groupValues.length; i++) {
                obj = this.highlightsSO.groupValues[i].ops.find(h => h.name === hc.value) ;
                    if (!!obj ) {
                        obj.checked = hc.checked;
            }
                }
            })



            return true;
        },

        highlightsDefault: function(){
            var highlightsNameValue = this.$.highlights_div.querySelectorAll(".highlightsName");
            var highlightsOpValue = this.$.highlights_div.querySelectorAll(".highlightsOp");

            var  pos = 0;
            for (var i = 0; i < this.highlights.length ; i++) {
                for (var j = 0; j < this.highlights[i].groupValues.length ; j++) {
                    highlightsNameValue[pos].value = this.highlights[i].groupValues[j].defaultValue;
                    highlightsOpValue[pos].value = this.highlights[i].groupValues[j].defaultOp;
                    pos++;
                }
            }

            var highlightsSOChecked = this.$.highlights_div.querySelectorAll(".highlightSOName");

            var pos = 0
            for (var i = 0; i < this.highlightsSO.groupValues.length ; i++) {
                for (var j = 0; j < this.highlightsSO.groupValues[i].ops.length ; j++) {
                    highlightsSOChecked[pos].checked = this.highlightsSO.groupValues[i].ops[j].defaultChecked;
                    //console.log(this.highlightsSO.groupValues[i].ops[j].defaultChecked, this.highlightsSO.groupValues[i].ops[j].name);
                    pos++;
                }

            }

        },

        initTitleMenu: function() {
            var list = document.getElementById('columnsMenu').getElementsByTagName("span");
            // Num colums to modify
            var num_search = 2;
            for (var i = list.length-1; i>0 && num_search>0; i--) {
                var title = list[i].innerText;             
                if (title.indexOf('Address') != -1) {
                    list[i].innerText = "Address Book";
                    num_search --;
                }
            }
        },

        ready: function() {
            if (localStorage.csvs_filter_history) {
                this.historyFilters = JSON.parse(localStorage.csvs_filter_history);

            }
            /*this.async(function () {
                this.getElementsByClassName('highlights_div').addEventListener("blur", function (event) {
                   // event.target.style.background = "pink";
                    alert('entra');
                }, true);
            })*/
           /* console.log(eltos);
            eltos.forEach(
                function(e){
                    e.addEventListener("blur", function( event ) {
                        event.target.style.background = "pink";
                        alert('entra');
                    }, true);
                }
            )*/
            //.addEventListener("blur", function( event ) {
            //this.$.highlights_div.querySelectorAll(".highlightsName").addEventListener("blur", function( event ) {
//                event.target.style.background = "pink";
            //}, true);

            var me = this;
            this.species = 'Homo sapiens';
            var lastQuery = '';
            this.geneValue = "PPL";

            this.async(function () { // DOM READY
                me.selectedMenuTool = me.$.menu.querySelector('div');
                me.$.gv.createGenomeViewer();
                me.$.gv.genomeViewer.draw();

                this.initTitleMenu();
            }, 50);

            this.columns = [{
                    name: 'chromosome',
                    title: "Chr",
                    disableSort: true,
                    width: 40
                }, {
                    name: 'position',
                    title: 'Position',
                    disableSort: true,
                    width: 70
                }, {
                    name: 'alleles',
                    title: 'Alleles',
                    width: 50,
                    disableSort: true,
                    formula: function(row) {
                        return row.reference + ">" + row.alternate;
                    }
                }, {
                    name: 'genes',
                    title: 'Gene',
                    width: 90,
                    defaultValue: ".",
                    disableSort: true,
                    disableTooltip: true,
                    formula: function(row){
                        if (row.genes != "" && row.genes != "." && row.genes !=  undefined) {
                            var genes = row.genes.split(',');
                            var result=[];
                            genes.forEach(
                                function(g) {
                                    result.push("<a class='link' href='https://www.genecards.org/cgi-bin/carddisp.pl?gene=" + g  +"' target='_blank' " +
                                        "title=" + g + ">"+g+"</a>");
                                }
                            );
                            return result.join(",");
                        } else
                            return row.genes;
                }
                }, {
                    name: 'id',
                    title: 'Id',
                    width: 90,
                    defaultValue: ".",
                    disableSort: true,
                    disableTooltip: true,
                    formula: function(row){
                        if (row.id != undefined) {
                            if (row.id != "" && row.id != ".")
                                return "<a class='link' href='https://www.ncbi.nlm.nih.gov/snp/" + row.id + "' target='_blank' " +
                                    "title=" + row.id + ">" + row.id + "</a>";
                            else
                                return row.id;
                        } else
                            return ".";
                    }
                },{
                    title: '<span title="Genotype counts:\n 0/0: homozygous reference\n 0/1: heterozygous\n 1/1: homozygous alterntive\n ./.: missing">Genotypes <sup><i class="fa fa-info-circle aria-hidden="true"></i></sup></span>',
                    name: 'genotypes',
                    width: 200,
                    columns: [{
                        name: "gt00",
                        width: 50,
                        title: '0/0',
                        disableSort: true,
                        formula: function(row) {
                            if (row.stats != null && row.stats.gt00 != null)
                                return row.stats.gt00;
                            else
                                return ".";
                            }
                    }, {
                        name: "gt01",
                        width: 50,
                        title: '0/1',
                        disableSort: true,
                        formula: function(row) {
                            if (row.stats != null && row.stats.gt01 != null)
                                return row.stats.gt01;
                            else
                                return ".";
                            }
                    }, {
                        name: "gt11",
                        width: 50,
                        title: '1/1',
                        formula: function(row) {
                            if (row.stats != null && row.stats.gt11 != null)
                                return row.stats.gt11;
                            else
                                return ".";
                            }
                    }, {
                        name: "gtmissing",
                        width: 50,
                        title: './.',
                        disableSort: true,
                        formula: function(row) {
                            if (row.stats != null && row.stats.gtmissing != null)
                                return row.stats.gtmissing;
                            else
                                return ".";
                        }
                    }]
                }, {
                    title: '<span title="Allele Frequency:\n 0 Freq: allele frequency for reference\n 1 Freq: allele frequency for alternative\n MAF: Minor Allele Frequency, the lowest value between 0 Freq and 1 Freq">Freq. <sup><i class="fa fa-info-circle aria-hidden="true"></i></sup></span>',
                    name: "freq",
                    width: 150,
                    disableSort: true,
                    columns: [{
                        name: "refFreq",
                        width: 50,
                        title:   '0 Freq',
                        formula: function(row) {
                            if (row.stats != null && row.stats.refFreq != null)
                                return row.stats.refFreq;
                            else
                                return ".";
                        }
                    }, {
                        name: "altFreq",
                        width: 50,
                        title: '1 Freq',
                        disableSort: true,
                        formula: function(row) {
                            if (row.stats != null && row.stats.altFreq != null)
                                return row.stats.altFreq;
                            else
                                return ".";
                        }
                    }, {
                        name: "maf",
                        width: 50,
                        title: 'MAF',
                        disableSort: true,
                        formula: function(row) {
                            if (row.stats != null && row.stats.maf != null)
                                return row.stats.maf;
                            else
                                return ".";
                        }
                    }]
                /* Remove CSVS
                }, {
                    title: "<span title='Alternate Allele Frequency in 1000 genomes project database (phase 1)'>1000G AAF (phase 1) <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                    width: 250,
                    name: 'aaf1000g',
                    visible: false,
                    columns: [{
                            name: "aaf1000G",
                            title: "ALL",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000G != null) {
                                    return row.aaf1000G;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000GAME",
                            title:  "<span title='AMR: American'>AMR <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000GAME != null) {
                                    return row.aaf1000GAME;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000GASI",
                            title: "<span title='ASN: Asian'>ASN <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000GASI != null) {
                                    return row.aaf1000GASI;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000GAFR",
                            title: "<span title='AFR: African'>AFR <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000GAFR != null) {
                                    return row.aaf1000GAFR;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000GEUR",
                            title:  "<span title='EUR: European'>EUR <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000GEUR != null) {
                                    return row.aaf1000GEUR;
                                } else {
                                    return ".";
                                }
                            }
                        }]*/
                     }, {
                        title: "<span title='Alternate Allele Frequency in 1000 genomes project database (phase 3)'>1000G AAF (phase 3) <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                        width: 150,
                        name: 'aaf1000G3',
                        columns: [{
                            name: "aaf1000G_PHASE_3_ALL",
                            title: "ALL",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000G_PHASE_3_ALL != null) {
                                    return row.aaf1000G_PHASE_3_ALL;
                                } else {
                                    return ".";
                                }
                            },
                        }, {
                            name: "aaf1000G_PHASE_3_AMR",
                            title:  "<span title='AMR: American '>AMR <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            visible: false,
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000G_PHASE_3_AMR != null) {
                                    return row.aaf1000G_PHASE_3_AMR;
                                } else {
                                    return ".";
                                }
                            },

                        }, {
                            name: "aaf1000G_PHASE_3_SAS",
                            title:  "<span title='SAS: South Asian'>SAS <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            visible: false,
                            formula: function(row) {
                                if (row.aaf1000G_PHASE_3_SAS != null) {
                                    return row.aaf1000G_PHASE_3_SAS;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000G_PHASE_3_EAS",
                            title:  "<span title='EAS: East Asian'>EAS <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            visible: false,
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000G_PHASE_3_EAS != null) {
                                    return row.aaf1000G_PHASE_3_EAS;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000G_PHASE_3_AFR",
                            title: "<span title='AFR: African'>AFR <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            visible: false,
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000G_PHASE_3_AFR != null) {
                                    return row.aaf1000G_PHASE_3_AFR;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aaf1000G_PHASE_3_EUR",
                            title: "<span title='EUR: European'>EUR <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function(row) {
                                if (row.aaf1000G_PHASE_3_EUR != null) {
                                    return row.aaf1000G_PHASE_3_EUR;
                                } else {
                                    return ".";
                                }
                            },
                        } ]

                    }, {
                        title: "<span title='Alternate Allele Frequency in Exome Aggregation Consortium (ExAC) database'>ExAC AAF <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                        width: 65,
                        name: 'aafexac',
                        columns: [{
                                name: "aafexac_ALL",
                                title: "ALL",
                                defaultValue: ".",
                                disableSort: true,
                                formula: function(row) {
                                    if (row.aafexac_ALL != null) {
                                        return row.aafexac_ALL;
                                    } else {
                                        return ".";
                                    }
                                }
                            }
                        ]
                    }, {
                        title: "<span title='Alternate Allele Frequency in Exome Sequencing Project (ESP) database'>ESP6500 AAF <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                        width: 100,
                        name: 'aaf6500',
                        columns: [{
                            name: "aafESP_ALL",
                            title: "ALL",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function (row) {
                                if (row.aafESP_ALL != null) {
                                    return row.aafESP_ALL;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "aafESP_EA",
                            title: "<span title='EA: European American'>EA <sup><i class=\"fa fa-info-circle\" aria-hidden=\"true\"></i></sup></span>",
                            defaultValue: ".",
                            disableSort: true,
                            formula: function (row) {
                                if (row.aafESP_EA != null) {
                                    return row.aafESP_EA;
                                } else {
                                    return ".";
                                }
                            }
                    }]
                }, {
                    name: 'sift',
                    title: '<span title="SIFT score predicts whether an amino acid substitution affects protein function. SIFT value less than 0.05 represents a \'deleterious\' prediction. SIFT value greater than or equal to 0.05 represents a \'tolerated\' prediction">SIFT <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    width: 50,
                    disableSort: true,
                    formula: function(row) {
                        if (row.sift !== null && typeof row.sift !== 'undefined') {
                            return row.sift;
                        } else {
                            return ".";
                        }
                    },
                    styleFormula: function(row) {
                        return me._getStyleFormula(row.sift, 'sift')
                    }
                },  {
                    name: 'polyphen',
                    title: '<span title="Polyphen score predicts the possible impact of an aninoacid subsitution on the structure and function of a protein. Polyphen scores can be benign (<0.446), possibly damaging (0.446-0.908) or probably damaging (>0.908)">Polyphen <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    width: 60,
                    disableSort: true,
                    formula: function(row) {
                        if (row.polyphen !== null  && typeof row.polyphen !== 'undefined') {
                            return row.polyphen;
                        } else {
                            return ".";
                        }
                    },
                    styleFormula: function(row) {
                        return me._getStyleFormula(row.polyphen, 'polyphen')
                    }
                }, {
                    name: 'phastcons',
                    title: '<span title="phastCons scores represent probabilities of negative selection and range between 0 and 1">phastCons <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    visible: false,
                    width: 60,
                    disableSort: true,
                    formula: function(row) {
                        if (row.phastcons !== null  && typeof row.phastcons !== 'undefined') {
                            return row.phastcons;
                        } else {
                            return ".";
                        }
                    },
                }, {
                    name: 'phylop',
                    title: '<span title="phyloP scores  measure the level of conservation of positions. Positive scores measure conservation whereas negative scores measure acceleration">phyloP <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    visible: false,
                    width: 50,
                    disableSort: true,
                    formula: function(row) {
                        if (row.phylop !== null  && typeof row.phylop !== 'undefined') {
                            return row.phylop;
                        } else {
                            return ".";
                        }
                    }
                }, {
                    name: 'gerp',
                    title: '<span title="GERP score estimates the level of conservation of positions. Positive scores represents a substitution deficit and this indicate that a site may be under evolutionary constraint. Negative scores indicate that a site is probably evolving neutrally. Some author suggest that scores >=2 indicate evolutionary constraint and >=3 indicate purifying selection">GERP <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    width: 50,
                    disableSort: true,
                    formula: function(row) {
                        if (row.gerp !== null  && typeof row.gerp !== 'undefined') {
                            return row.gerp;
                        } else {
                            return ".";
                        }
                    },
                    styleFormula: function(row) {
                        return me._getStyleFormula(row.gerp,"gerp")
                    }
                }, {
                    name: 'cadd',
                    title: '<span title="CADD tool scores the deleteriousness of snvs and indels. Higher values indicate more likely to have deleterious effects">CADD <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    width: 50,
                    disableSort: true,
                    formula: function(row) {
                        if (row.cadd !== null  && typeof row.cadd !== 'undefined') {
                            return row.cadd;
                        } else {
                            return ".";
                        }
                    },
                    styleFormula: function(row) {
                        return me._getStyleFormula(row.cadd, 'cadd')
                    }
                }, {
                    name: 'ct',
                    title: '<span title="Worst consequence type found among all transcripts">Worst consequence type <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    width: 150,
                    disableSort: true,
                    formula: function (row) {
                        return row.annots.displayConsequenceType;
                    },
                    styleFormula: function(row) {
                        return me._getStyleFormulaConsequence(row.annots.displayConsequenceType, 'ct')
                    }
                }, {
                    name: 'phenotypes',
                    title: '<span title="Information about relationships among human variations and Clinvar and Cosmic databases">Phenotypes <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    //width: 450,
                    width: 300,
                    columns: [{
                        name: 'clinvar',
                        title: 'Clinvar',
                        width: 150,
                        disableSort: true,
                        formula: function(row) {
                            try {
                                return row.phenotypes.clinvar;
                            } catch (e) {
                                return ".";
                            }
                        }
                    }, {
                        name: 'cosmic',
                        title: 'Cosmic',
                        width: 150,
                        disableSort: true,
                        formula: function(row) {
                            try {
                                return row.phenotypes.cosmic;
                            } catch (e) {
                                return ".";
                            }

                        }
                    /* No data about GWAS in cellbase
                    }, {
                        name: 'gwas',
                        title: 'GWas',
                        width: 150,
                        disableSort: true,
                        formula: function(row) {
                            try {
                                return row.phenotypes.gwas;
                            } catch (e) {
                                return ".";
                            }

                        }*/
                    }]
                },
                {
                    name: 'addressBook',
                    title: '<span title="Send a request to the reporter of this variant">Contact <br/> request <sup><i class="fa fa-info-circle" aria-hidden="true"></i></sup></span>',
                    width: 60,
                    disableSort: true,
                    formula: function (row) {
                        var variant = row.chromosome + ":" + row.position + " " + row.reference + ">" + row.alternate;
                    return "<csvs-address-book variant='"+ variant + "'></csvs-address-book>";
                    }
                }
            ];
            this.reloadChart({});
        },
        downloadFiles: function(e) {
            //this.query.limit = 0;
            var newQuery = this.query;
            newQuery.skip=(this.$.dataTable.currentPage -1) * this.$.dataTable.pageSize;
            newQuery.enableSkip=true;

            var me = this;
            var url = CSVSManager.variants.fetch({
                query: newQuery,
                request: {
                    success: function(r) {
                        var stringToSave = "Chr"+ "\t"+"Position"+ "\t"+"alleles"+ "\t"+"0/0"+ "\t"+"0/1"+ "\t"+"1/1"
                                + "\t"+"./,"+ "\t"+"0Freq"+ "\t"+ "1Freq"+ "\t"+ "MAF"+"\n";

                        if (!!window.CSVS_LIMIT_MAX && r.numTotalResults > window.CSVS_LIMIT_MAX)
                            new StvDialog().alert('Only a maximum of '+ CSVS_LIMIT_MAX + ' variants is downloaded.');

                        for( var i = 0; i < r.result.length; i++){
                            stringToSave = stringToSave + me._csvToString(r.result[i]);
                        }
                        var blob = new Blob([stringToSave], {
                            type: "text/plain;charset=utf-8"
                        });
                        saveAs(blob, "csvs.txt");
                    },
                    error:function(r){
                        console.log("error in save");
                    }
                },
            });
        },
        _csvToString: function(o){
            return  "chr" + o.chromosome + "\t" + o.position + "\t" + o.reference + ">" + o.alternate +
                    "\t" + o.stats.gt00 + "\t" + o.stats.gt01 + "\t" + o.stats.gt11 +"\t" +
                    o.stats.gtmissing + "\t" + o.stats.refFreq + "\t" + o.stats.altFreq + "\t"+ o.stats.maf +"\n";
        },
        _toFixed: function(value, precision) {
            return Number(value).toFixed(precision);
        },
        _setQuickSearchMenu: function(query) {

            while (this.$.searchDataList.firstChild) {
                this.$.searchDataList.removeChild(this.$.searchDataList.firstChild);
            }
            this.quickSearchDataset = {};
            var items = this._quickSearchResultFn(query);
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var value = item["name"];
                this.quickSearchDataset[value] = item;
                var menuEntry = document.createElement('option');
                menuEntry.setAttribute('value', value);
                this.$.searchDataList.appendChild(menuEntry);
            }

        },
        _quickSearchResultFn: function(query) {
            var results = [];
            var speciesCode = stv.utils.getSpeciesCode(this.species);

            CellBaseManager.get({
                host: CELLBASE_HOST,
                version: CELLBASE_VERSION,
                species: speciesCode,
                category: 'feature',
                subCategory: 'id',
                query: query,
                resource: 'starts_with',
                params: {
                    limit: 10
                },
                async: false,
                success: function(data, textStatus, jqXHR) {
                    results = data.response[0].result;
                }
            });
            return results;
        },
        submitForm: function(e) {

            if (!!this.$.frequency) {
                this.$.frequency.isEmpty = true;
            }
            if (!!this.$.phenotype){
                this.$.phenotype.isCosmicEmpty = true;
                this.$.phenotype.isGwasEmpty = true;
                this.$.phenotype.isClinvarEmpty = true;
            }
            if (!!this.$.effect)
                this.$.effect.isEmpty = true;

            var me = this;
            var query = {};
            var regionValue = this.$.filterPosition.checkRegion();
            if (regionValue == -1) {
                return;
            }

            var geneValue = this.$.filterPosition.checkGene();


            var regions = [];
            if (regionValue != null) {
                regions = regionValue.split(",");
                if (regions.length > this.maxLength && !this.isLogged) {
                    new StvDialog().alert("The total size of all provided regions can't exceed " + this.maxLength + " positions");
                    return
                }
            }

            if (!this.saturation && !this.handleHighlights())
                return

            var genes = [];
            if (geneValue != null) {

                genes = geneValue.split(",");
                for (var i = 0; i < genes.length; i++) {
                    genes[i] = genes[i].trim();
                }

                if (genes.length > 5 && !this.isLogged) {
                    new StvDialog().alert("The maximum number of genes is 5");
                    return;
                }

                var gene = genes.join(",").toUpperCase();

                var regionGene = {};

                CellBaseManager.get({
                    species: 'hsapiens',
                    category: 'feature',
                    subCategory: 'gene',
                    query: gene,
                    resource: "info",
                    async: false,
                    params: {
                        include: 'chromosome,start,end'
                    },
                    success: function(data) {
                        for (var i = 0; i < data.response.length; i++) {
                            var queryResult = data.response[i];

                            if (queryResult.result.length > 0) {
                                var region = new Region(queryResult.result[0]);
                                regionGene[region] = queryResult.id;
                                regions.push(region.toString());

                            } else {
                                new StvDialog().alert("Wrong gene: " + gene);
                            }
                        }
                    }
                });
            }

            var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
            var diseaseIds = [];


            for (var i = 0; i < diseaseEls.length; i++) {
                var el = diseaseEls[i];
                if (el.checked) {
                    diseaseIds.push(el.getAttribute("value"));
                }
            }

            var technologyEls = this.$.technologies_div.querySelectorAll(".technologyName");
            var technologyIds = [];

            for (var i = 0; i < technologyEls.length; i++) {
                var el = technologyEls[i];
                if (el.checked) {
                    technologyIds.push(el.getAttribute("value"));
                }
            }

            if (regions.length > 0) {
                var regionQuery = regions.join(",");
                query.regions = regionQuery;
                query.diseases = diseaseIds.join(",");
                query.technologies = technologyIds.join(",");
                query.skipCount = false;

                // Select tab saturation
                if (this.saturation){
                    // show msj loading
                    this.loadingSaturation = true;
                    // remove data chart
                    this.reloadChart({});
                    CSVSManager.regions.saturation({
                        id: regionQuery,
                        query: query,
                        request: {
                            success: function(response) {

                                var data = response.result[0];

                                for (var region in regionGene) {
                                    if (region in data) {
                                        var newKey = regionGene[region];
                                        data[newKey] = data[region];
                                        delete data[region];
                                    }
                                }
                                try {
                                    me.reloadChart(data);
                                    // remove msj loading
                                    me.loadingSaturation = false;
                                } catch (e) {
                                    me.reloadChart({});
                                    // remove msj loading
                                    me.loadingSaturation = false
                                }

                            }
                        }
                    });
                } else {
                    // Select tab saturation search
                    var url = CSVSManager.variants.fetch({
                        query: query,
                        request: {
                            url: true
                        }
                    });

                    // url == formURl no search but reload data
                    if (url == this.formURL){
                        this.urlChanged(url, this.formURL);
                    }

                    this.formURL = url;
                }
            }
            // e -> If event is click check region/gene
            if (regions.length == 0 && genes.length == 0 && e != undefined) {
                new StvDialog().alert("Please add a region/gene and check any subpopulation/technology");
            }

            query.gene = geneValue;
            this.set('query', query);

        },
        _formatText: function(text) {
            return stv.utils.formatText(text, "_").toLowerCase().replace(/(?:^|\s)\S/g, function(a) {
                return a.toUpperCase();
            });
        },
        clearForm: function() {

            this.$.filter_form.reset();
            this.$.filterPosition.clear();
            this.highlightsDefault();
        },
        loadForm: function(hf) {
            var filterName = [];
            var hfAux = hf;
            if (hf.regions != "" && hf.regions != null) {
                hfAux.region = hf.regions;
            }
            var fP = this.$.filterPosition.load(hfAux);
            if (fP.length > 0) {
                for (var i = 0; i < fP.length; i++) {
                    filterName.push(fP[i]);
                }
            }

            if (hf.diseases != "" && hf.diseases != null) {
                var disName = [];
                var dis = hf.diseases.split(",");
                var aux = this.$.diseases_div.querySelectorAll("input");
                for (var i = 0; i < aux.length; i++) {
                    aux[i].checked = false;
                }
                for (var i = 0; i < dis.length; i++) {
                    for (var j = 0; j < aux.length; j++) {
                        var id = aux[j].value;
                        if (dis[i] == id) {
                            aux[j].checked = true;
                            for (var k = 0; k < this.diseases.length; k++) {
                                if (id == this.diseases[k].groupId) {
                                    disName.push(this.diseases[k].name);
                                }
                            }
                        }
                    }
                }
                filterName.push("Disease: " + disName.join(",") + " ");
            }
            return filterName.join(" AND ");
        },
        loadFilter: function(e) {
            e.stopPropagation();
            this.clearForm();
            this.loadForm(e.currentTarget.dataFilter);
            this.$.filterHistoryTooltip.handleClose(e);
            this.submitForm();
        },
        clearFiltersHistory: function(e) {
            e.stopPropagation();
            this.historyFilters = [];
            localStorage.csvc_filter_history = JSON.stringify(this.historyFilters);

        },

        selectAllDiseases: function(e, d, s) {
            var name = (e.target != undefined && e.target.getAttribute("name") == "CSVS") ? "diseaseNameCSVS": "diseaseName";
            var checkboxes = this.$.filter_form.getElementsByClassName(name);
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        selectAllTechnologies: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("technologyName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        selectAllHighlights: function(e, d, s) {
           this.$.highlightsConsequenceTypes.selectAllHighlights(e,d,s);
            e.stopPropagation();
        },
        deselectAllDiseases: function(e, d, s) {
            var name = (e.target != undefined && e.target.getAttribute("name") == "CSVS") ? "diseaseNameCSVS": "diseaseName";
            var checkboxes = this.$.filter_form.getElementsByClassName(name);
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        },
        deselectAllTechnologies: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("technologyName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        },

        deselectAllHighlights: function(e, d, s) {
            this.$.highlightsConsequenceTypes.deselectAllHighlights(e,d,s);
            e.stopPropagation();
        },

        urlChanged: function(neo, old) {

            var me = this;

            if (neo == null || neo == "") {
                return;
            }
            this.request = {
                url: this.formURL,
                auxTotalCount: -1,
                parse: function(response) {
                    return me._parse(response);
                },
                parseTotal: function(response) {
                    var total = me._parseTotal(response);

                    me.numTotalResults = total;

                    if (this.auxTotalCount == -1) {

                        this.auxTotalCount = total;

                        this.url = this.url.replace("&skipCount=false", "&skipCount=true");

                    } else {
                        me.numTotalResults = this.auxTotalCount;
                        total = me.numTotalResults;
                    }

                    me.set('numTotalResults', -1);
                    me.set('numTotalResults', total);
                    return total;
                },
            };

        },

        _getWorst: function(listConsType) {
            var worst = {};

            listConsType.forEach(ct => {
                var obj;
                for (var i = 0; i < this.highlightsSO.groupValues.length; i++) {
                    obj = this.highlightsSO.groupValues[i].ops.find(h => h.name === ct) ;
                    if (!!obj && !!obj.order && (worst.order == undefined || obj.order < worst.order)) {
                        worst.ct = ct;
                        worst.order = obj.order;
                    }
                }
              return worst;
            });
            return worst.ct;
        },

        _parse: function(response) {
            var me = this;
            var data = response.result;
            var positions = [];
            var positionsDoubleVariant = [];
            var doubleVariant = [];
            var referencePosition = [];
            var referenceVariant = [];
            //Cellbase use - never * o nothing, we need change, annotate and change
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                if(row.alternate == ""){
                    positionsDoubleVariant.push(i);
                    doubleVariant.push(row.alternate);
                    row.alternate = "-";
                }

                if(row.alternate != undefined && (row.alternate).indexOf(",") != -1){
                    positionsDoubleVariant.push(i);
                    doubleVariant.push(row.alternate);
                    row.alternate = row.alternate.split(",")[0];
                    if(row.alternate == ""){
                        row.alternate = "-";
                    }
                }

                if(row.reference == ""){
                    referencePosition.push(i);
                    referenceVariant.push(row.reference);
                    row.reference = "-";
                }

                var variant = row.chromosome + ":" + row.position + ":" + row.reference + ":" + row.alternate;
                positions.push(variant);
            }

            // Annotate
            var query = positions.join(",");
            if (positions.length > 0) {

                CellBaseManager.get({
                    host: CELLBASE_HOST,
                    version: CELLBASE_VERSION,
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'variant',
                    resource: 'annotation',
                    query: query,
                    async: false,
                    success: function(response) {
                        try {
                            var annotData = response.response;
                            for (var i = 0; i < annotData.length; i++) {
                                var obj = annotData[i];
                                if (obj.result.length > 0) {
                                    var annots = obj.result[0];
                                    data[i].annots = annots;
                                }
                            }
                        } catch (e) {}
                    },
                    error: function(e) {
                        // debugger
                    }
                });
            }

            for (var z = 0; z < positionsDoubleVariant.length; z++) {
                data[positionsDoubleVariant[z]].alternate = doubleVariant[z];
            }
            // Get value "" or "*" from CSVS
            for (var z = 0; z < referencePosition.length; z++) {
                data[referencePosition[z]].reference =  referenceVariant[z];
             }

            for (var i = 0; i < data.length; i++) {
                var variant = data[i];

                if (variant.annots == null) {
                    continue;
                }

                // Annotate SNPid
                if (variant.annots.id != null && variant.annots.id) {
                    variant.id = variant.annots.id;
                }

                // Annotate Cons
                if (variant.annots.conservation != null && variant.annots.conservation.length > 0) {

                    for (var j = 0, l = variant.annots.conservation.length; j < l; j++) {
                        var crs = variant.annots.conservation[j];
                        if (crs) {
                            score = crs.score.toFixed(3)
                            switch (crs.source.toLowerCase()) {
                                case 'phastcons':
                                    variant.phastcons = score;
                                    break;
                                case 'phylop':
                                    variant.phylop = score;
                                    break;
                                case 'gerp':
                                    variant.gerp = score;
                                    break;
                                default:
                            }
                        }
                    }
                }


                // Annotate CT && Subs. Score
                if (variant.annots.consequenceTypes != null && variant.annots.consequenceTypes.length > 0) {

                    var sif = -1;
                    var sifDesc = "";
                    var poly = -1;
                    var polyDesc = "";
                    var genes = [];

                    for (var j = 0, l = variant.annots.consequenceTypes.length; j < l; j++) {
                        var ct = variant.annots.consequenceTypes[j];

                        if (ct != null && ct != "undefined") {
                            if (ct.geneName != null && ct.geneName.length > 0 && genes.indexOf(ct.geneName) < 0) {
                                genes.push(ct.geneName);
                            }

                            if (ct.proteinVariantAnnotation != null && ct.proteinVariantAnnotation.substitutionScores != null && ct.proteinVariantAnnotation.substitutionScores.length > 0) {
                                var auxSift = null;
                                var auxPoly = null;
                                for (var k = 0, lP = ct.proteinVariantAnnotation.substitutionScores.length; k < lP; k++) {
                                    var pss = ct.proteinVariantAnnotation.substitutionScores[k];
                                    switch (pss.source.toLowerCase()) {
                                        case 'sift':
                                            auxSift = pss;
                                            break;
                                        case 'polyphen':
                                            auxPoly = pss;
                                            break;
                                    }
                                }

                                if (auxPoly != null && auxSift != null) {
                                    if (auxPoly.score > poly) {
                                        sif = auxSift.score;
                                        poly = auxPoly.score;

                                        sifDesc = auxSift.description;
                                        polyDesc = auxPoly.description;

                                    }
                                }

                            }
                        }
                    }
                    if (sif != -1 && poly != -1) {
                        variant.sift = sif;
                        variant.polyphen = poly;
                    }

                    if (genes.length > 0) {
                        variant.genes = genes.join(",");
                    }
                }

                // Functional Score
                if (variant.annots.functionalScore != null && variant.annots.functionalScore.length > 0) {
                    var cadd = null;
                    for (var j = 0; j < variant.annots.functionalScore.length; j++) {
                        var cadd_elem = variant.annots.functionalScore[j];
                        switch (cadd_elem.source.toLowerCase()) {
                            case 'cadd_raw':
                                cadd = cadd_elem.score.toFixed(3);
                                break;
                            case 'cadd_scaled':
                                break;
                        }
                    }
                    if (cadd != null) {
                        variant.cadd = cadd;
                    }
                }

                // Clinical
                variant.phenotypes = {
                    cosmic: "",
                    gwas: "",
                    clinvar: ""
                };

                if (variant.annots.variantTraitAssociation != null) {
                    var clinical = variant.annots.variantTraitAssociation;

                    var phenotypesCosmic = [];
                    var phenotypesGwas = [];
                    var phenotypesClinvar = [];
                    if (clinical.cosmic != null) {
                        for (var j = 0; j < clinical.cosmic.length; j++) {
                            var cosmic = clinical.cosmic[j];
                            if (cosmic.primaryHistology != null && cosmic.primaryHistology != "") {
                                phenotypesCosmic.push(cosmic.primaryHistology);
                            }
                        }
                    }

                    if (clinical.gwas != null) {
                        for (var j = 0; j < clinical.gwas.length; j++) {
                            var gwas = clinical.gwas[j];
                            for (var k = 0; k < gwas.traits.length; k++) {
                                var trait = gwas.traits[k];
                                if (trait != null && trait != "") {
                                    phenotypesGwas.push(trait);
                                }
                            }
                        }
                    }

                    if (clinical.clinvar != null) {
                        for (var j = 0; j < clinical.clinvar.length; j++) {
                            var clinvar = clinical.clinvar[j];
                            for (var k = 0; k < clinvar.traits.length; k++) {
                                var trait = clinvar.traits[k];
                                if (trait != null && trait != "") {
                                    phenotypesClinvar.push(trait);
                                }
                            }
                        }
                    }

                    var phenotypesCosmicFinal = phenotypesCosmic.filter(function(item, pos) {
                        return phenotypesCosmic.indexOf(item) == pos;
                    });
                    var phenotypesGwasFinal = phenotypesGwas.filter(function(item, pos) {
                        return phenotypesGwas.indexOf(item) == pos;
                    });
                    var phenotypesClinvarFinal = phenotypesClinvar.filter(function(item, pos) {
                        return phenotypesClinvar.indexOf(item) == pos;
                    });


                    variant.phenotypes = {
                        cosmic: phenotypesCosmicFinal.join(","),
                        gwas: phenotypesGwasFinal.join(","),
                        clinvar: phenotypesClinvarFinal.join(",")
                    };
                }

                if (variant.annots.populationFrequencies != null) {

                    for (var j = 0; j < variant.annots.populationFrequencies.length; j++) {

                        var pfreq = variant.annots.populationFrequencies[j];
                        /* Remove CSVS
                        if (pfreq.study.toLowerCase() === "1000genomes_phase_1") {
                            switch (pfreq.population) {
                                case "ALL":
                                    variant.aaf1000G = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;

                                case "AMR":
                                    variant.maf1000GAME = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;

                                case "ASN":
                                    variant.maf1000GASI = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;

                                case "AFR":
                                    variant.aaf1000GAFR = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;

                                case "EUR":
                                    variant.aaf1000GEUR = Number(maf).toFixed(3)
                                    break;
                            }
                        } else
                            */
                        if (pfreq.study.toLowerCase() === "1kg_phase3") {
                            switch (pfreq.population) {
                                case "ALL":
                                    variant.aaf1000G_PHASE_3_ALL = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;
                                case "SAS":
                                    variant.aaf1000G_PHASE_3_SAS = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;
                                case "EAS":
                                    variant.aaf1000G_PHASE_3_EAS = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;
                                case "AMR":
                                    variant.aaf1000G_PHASE_3_AMR = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;
                                case "AFR":
                                    variant.aaf1000G_PHASE_3_AFR = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;
                                case "EUR":
                                    variant.aaf1000G_PHASE_3_EUR = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;

                            }
                        } else if (pfreq.study.toLowerCase() === "esp6500") {
                            switch (pfreq.population) {
                                case "EA":
                                    variant.aafESP_EA = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;
                                case "AA":
                                    variant.aafESP_AA = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;
                                case "ALL":
                                    variant.aafESP_ALL = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;


                            }
                        } else if (pfreq.study.toLowerCase() === "exac") {
                            switch (pfreq.population) {
                                case "ALL":
                                    variant.aafexac_ALL = Number(pfreq.altAlleleFreq).toFixed(3);
                                    break;
                                case "EUR":
                                    variant.aafexac_EUR = Number(pfreq.altAlleleFreq).toFixed(3)
                                    break;
                            }
                        }
                    }
                }
            }
            return data;
        },
        _parseTotal: function(response) {
            if (response != null) {
                var total = response.numTotalResults;
            } else {
                total = 0;
            }
            return total;
        },

        // Get data search to conctact
        getDataSearch: function(e){
            var data_search = {};
            data_search.regionsSearch = this.$.filterPosition.checkRegion();
            data_search.geneSearch = this.$.filterPosition.checkGene();


            var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
            var diseaseIds = [];
            diseaseEls.forEach(function(d){
                if (d.checked)
                    diseaseIds.push(d.getAttribute("value"));
            });

            var technologyEls = this.$.technologies_div.querySelectorAll(".technologyName");
            var technologyIds = [];
            technologyEls.forEach(function(t){
                if (t.checked)
                    technologyIds.push(t.getAttribute("value"));
            });
            data_search.diseasesSearch = diseaseIds.join(",");
            data_search.technologiesSearch = technologyIds.join(",");
            e.target.search = data_search;
         },

        // enable scroll when popup is closed
        enableScroll: function(e){
            this.$.dataTable.handleScroll = function(e) {
                if (this.enablePaging == true) {
                    e.preventDefault();
                    if (e.deltaY > 0) {
                        this.handleNextClick();
                    }
                    if (e.deltaY < 0) {
                        this.handlePreviousClick();
                    }
                }
            }
        },
        // disable scroll when popup is closed
        disableScroll: function(e){
            this.$.dataTable.handleScroll =  function(e) { }
        },


        handleRowClick: function(e) {
            var row = e.detail.row;


            // Call if change row
            if (this.$.effect.row != row){
                this.$.gv.genomeViewer.setRegion(row);
                this.$.effect.row = row;
                this.$.frequency.row = row;
                this.$.phenotype.row = row;
            }

        },
        handleMenuClick: function(e) {
            this.selectedMenuTool = e.currentTarget;
        },
        selectedMenuChanged: function(neo, old) {
            if (old) {
                old.removeAttribute('selected');
                this.$[old.dataset.option].setAttribute('hidden', '');
            }
            if (neo && !this.hidden) {
                neo.setAttribute('selected', '');
                this.$[neo.dataset.option].removeAttribute('hidden');
            }
        },
        handleGenomeViewerCreated: function() {
            var me = this;

            var adapter = new FeatureTemplateAdapter({
                uriTemplate: CSVS_HOST + '/regions/{region}/fetch',

                species: this.$.gv.genomeViewer.species,
                parse: function(response) {
                    var itemsArray = [];

                    for (var i = 0; i < response.result.length; i++) {
                        var r = response.result[i];
                        for (var j = 0; j < r.length; j++) {
                            var elem = r[j];
                            elem.start = elem.position;
                            elem.end = elem.position;
                        }
                        itemsArray.push(r);
                    }

                    return itemsArray;
                },
                parseHistogram: function(response) {
                    var itemsArray = [];
                    for (var i = 0; i < response.result.length; i++) {
                        var r = response.result[i]
                        for (var j = 0; j < r.length; j++) {
                            var interval = r[j];
                            interval.features_count = interval.featuresCount;
                            console.log(interval.features_count);
                            itemsArray.push(interval);
                        }
                    }
                    return itemsArray;
                }
            });

            var args = FEATURE_TYPES.undefined;
            args.handlers = {
                "feature:click": function(e) {

                    var elem = e.feature;
                    console.log(elem);

                    me.$.dataTable.selectElem(elem, function(x, y) {
                        return x.chromosome == y.chromosome && x.position == y.position &&
                            x.reference == y.reference && x.alternate == y.alternate;
                    });
                }
            }

            var track = new FeatureTrack({
                title: window.ACRONYM_APP ||'CSVS',
                featureType: window.ACRONYM_APP || 'csvs',
                minHistogramRegionSize: 12000,
                maxLabelRegionSize: 3000,
                height: 120,
                renderer: new FeatureRenderer(args),
                dataAdapter: adapter
            });

            this.$.gv.genomeViewer.addTrack(track);
        },
        diseasesChanged: function(neo, old) {

            if (neo && Array.isArray(neo)) {
                var diseasesSort = [];
                var diseaseMap = {};
                var diseaseNameMap = {};

                for (var i = 0; i < neo.length; i++) {
                    diseasesSort.push(neo[i]);
                    diseaseMap[neo[i].groupId] = neo[i];
                    diseaseNameMap[neo[i].name] = neo[i];
                }

                diseasesSort.sort(function(a, b) {
                    return b.samples - a.samples;
                });
                this.diseasesSort = diseasesSort;
                this.diseaseMap = diseaseMap;
                this.diseaseNameMap = diseaseNameMap;
            }
        },
        _getDiseaseCount: function(data, disease) {
            var count = 0;

            for (var i = 0; i < data.length; i++) {
                var elem = data[i];
                if (elem.diseaseId == disease.groupId) {
                    count = elem.count;
                }
            }
            return count;
        },
        removeZeroValues: function(data) {
            var auxTable = [];

            for (key in data) {
                var row = data[key];
                auxTable.push(row);
            }

            if (auxTable.length > 0) {
                var len = auxTable[0].length;

                for (var j = 0; j < len; j++) {
                    var allZero = true;

                    for (var i = 0; i < auxTable.length && allZero; i++) {
                        if (auxTable[i][j] != undefined &&  auxTable[i][j].count != 0) {
                            allZero = false;
                        }

                    }

                    if (allZero) {
                        for (var i = 0; i < auxTable.length; i++) {
                            auxTable[i][j] = null;
                        }
                    }
                }

                for (key in data) {
                    data[key] = data[key].filter(function(row) {
                        return row != null;
                    })
                }
            }
        },
        reloadChart: function(data) {
            var me = this;
            var chartData = [];

            var diseaseBreaks = [];
            var diseaseBreaksCheck = false;

            this.removeZeroValues(data);

            for (var key in data) {
                var diseaseData = data[key];

                if (!diseaseBreaksCheck) {
                    diseaseBreaksCheck = true;
                    diseaseBreaks = Array(diseaseData.length).fill(0);
                    var totalSample = 0;
                    for (var i = 0; i < diseaseData.length; i++) {
                        var elem = diseaseData[i];
                        totalSample += elem.samples;
                        diseaseBreaks[i] = elem.samples;
                    }
                    for (var i = 0; i < diseaseBreaks.length; i++) {
                        var value = Math.floor((diseaseBreaks[i] / totalSample) * 50);
                        diseaseBreaks[i] = {
                            from: i,
                            to: i,
                            breakSize: value
                        }
                    }
                    diseaseBreaks.unshift({
                        from: 0,
                        to: 0,
                        breakSize: 0
                    });
                }
                var counts = [];

                var labels = [];
                var total = 0;
                var j = 0;
                for (var i = 0; i < diseaseData.length; i++) {
                    var elem = diseaseData[i];
                    var dis = this.diseaseMap[elem.diseaseId];

                    labels.push(dis.name);
                    counts.push({
                        x: elem.samples,
                        y: elem.count,
                        _count: elem.count,
                        _samples: elem.samples,
                        _disease: dis.name
                    });

                    total += elem.count;
                }

                for (var i = 1; i < counts.length; i++) {
                    counts[i].y += counts[i - 1].y;
                    counts[i].x += counts[i - 1].x;
                }
                for (var i = 0; i < counts.length; i++) {

                    counts[i].radius = counts[i]._count / 5; //1/(counts[i]._count);
                    counts[i].fillColor = Highcharts.Color(Highcharts.getOptions().colors[chartData.length]).setOpacity(0.7).get('rgba');
                    if (counts[i].radius > 120) {
                        counts[i].radius = 120;
                        counts[i].lineWidth = 5;
                        counts[i].lineColor = Highcharts.Color('#dddddd').setOpacity(0.7).get('rgba');
                    }
                }

                labels.unshift(
                    ""
                );
                counts.unshift({
                    y: 0,
                    x:0
                });


                chartData.push({
                    name: key,
                    data: counts
                });


            }

            me.$.tvSaturation.dataSaturation=chartData;

            var chart = new Highcharts.Chart({
                _me: me,

                loading: {
                    labelStyle: {
                        color: '#445D76',
                        fontSize: "18px"
                    },
                    style: {
                        backgroundColor:'rgba(150,150,150,0.2)'
                    }
                },
                chart: {
                    type: 'line',
                    plotBackgroundColor: null,
                    plotBorderWidth: 1,
                    plotShadow: false,
                    renderTo: this.$.chart,
                    borderRadius: 10,
                   // width: 1000,
                    height: 700,
                    minWidth:900,
                    pointStart: 0,
                    _me: me
                },
                exporting: {},
                title: {
                    text: "Saturation"
                },
                tooltip: {
                    useHTML: true,
                    formatter: function() {
                        //                        debugger
                        var point = this.point;
                        if(point._samples != undefined)
                            return ' Disease Group: <b>' + point._disease + '</b><br> New Variants: <b>' + point._count + '</b> <br> Acum. Variants: <b>' + this.y + '</b></br>Samples: <b>' + point._samples + '</b>' +
                                '</br>Acum. Samples: <b>' + this.x + '</b>'
                                ;
                        else
                            return ' Disease Group: <b> </b><br> New Variants: <b>0 </b> <br> Acum. Variants: <b>0 </b></br>Samples: <b> 0</b>';

                    }
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    labels: {
                        rotation: 335
                    },
                    crosshair: {
                        width: 2,
                        color: 'gray',
                        dashStyle: 'shortdot'
                    },
                    title: {
                        text: 'Num. samples'
                    },
                },

                yAxis: {
                    title: {
                        text: 'Num. variants'
                    },
                    min: 0,
                    startOnTick: true,
                    crosshair: {
                        width: 2,
                        color: 'gray',
                        dashStyle: 'shortdot'
                    }                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: chartData
            });

            if (this.loadingSaturation && Object.entries(data).length == 0)
                chart.showLoading('<i class="fa fa-circle-o-notch fa-spin"></i> Loading... ');
            else
                chart.hideLoading();

        }
    });
</script>
