<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/jsorolla/src/lib/components/jso-genome-viewer-element.html">

<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-position.html">
<link rel="import" href="../bower_components/stevia-elements/src/stv-tooltip.html">

<script src="../bower_components/stevia-elements/src/manager/cellbase-manager.js"></script>

<link rel="import" href="csvs-saturation-element.html">

<dom-module id="csvs-search-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            background-color: var(--text-primary-color);
            color: var(--primary-text-color);
        }

        #filter-form-element {
            background-color: #FFFFFF;
            width: 250px;
            margin: 20px;
            min-height: 900px;
        }

        textarea {
            resize: none;
        }

        .searchGene {
            margin-top: 5px;
        }

        #dataGridElement {
            border-radius: 0px !important;
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 290px);
        }

        #saturationDiv {
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 290px);
        }

        .container> span {
            margin-left: 10px;
        }

        .stv-form-box {
            width: 250px;
            ;
        }

        #diseases_div,
        #technologies_div {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }

        #technologies_div {
            height: 150px;
        }

        #exportBtn {
            height: 20px;
        }

        #dataTable {
            font-size: 11px;
        }

        stv-table {
            overflow-y: auto;
        }

        stv-table::shadow #list {
            height: 300px;
            overflow-x: auto
        }

        stv-table::shadow {
            font-size: 11px;
        }

        #menu {
            margin-top: 15px;
        }

        #menu> div {
            font-size: 17px;
            padding: 5px 5px;
            margin: 0 20px;
            border-bottom: 2px solid transparent;
            transition: all 0.1s;
            cursor: pointer;
        }

        #menu> div:hover {
            border-bottom-color: rgba(125, 125, 125, 0.4);
        }

        #menu> div[selected] {
            border-bottom-color: rgba(125, 125, 125, 0.7);
        }

        #tools {
            margin-top: 10px;
        }

        .tool {
            min-height: 800px;
            width: 100%;
        }

        jso-genome-viewer-element,
        #dataTable {
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
        }

        stv-form-box {
            min-width: 250px;
        }

        #dataTable {
            border: 1px solid var(--divider-color)
        }

        stv-tooltip::shadow #messageInfo::shadow {
            height: 300px;
            width: 500px;
            background-color: #e2e9e9;
            border: 1px solid #e2e9e9;
            color: black;
            font-style: normal;
        }

        stv-tooltip::shadow .closeInfo::shadow {
            margin-left: 490px;
        }

        .tit {
            margin-top: 10px;
            border-bottom: 1px solid #445D76;
            font-weight: bold;
        }

        .name {
            width: 300px;
        }

        .num {
            width: 100px;
        }

        .clear-but {
            width: 100px;
            background-color: #f0f4f4 !important;
        }

        #filterHistoryTable> div:hover {
            background-color: #8ba7a7;
            border: 1px solid #8ba7a7;
        }

        #filter-name {
            text-overflow: ellipsis;
            width: 300px;
            white-space: nowrap;
            overflow: hidden;
        }

        .check {
            cursor: pointer;
            color: var(--secondary-text-color);
            padding-right: 2px;
        }

        .check:hover {
            color: var(--accent-color);
            font-weight: bold;
        }
    </style>
    <template>
        <div class="horizontal layout">
            <div id="filter-form-element">
                <form id="filter_form" class="vertical layout">
                    <div class="vertical layout">
                        <div id="buttons_container" class="horizontal layout end-justified" style="margin:10px 5px;">
                            <!-- <stv-tooltip id="filterHistoryTooltip" class="stv-btn stv-btn-shdw" title="Filters History" icon="filter" style="margin-right: 3px;">
                                <div class="stv-btn stv-btn-shdw clear-but" title="Clear Filters History" on-click="clearFiltersHistory">
                                    Clear
                                </div>
                                <div class="horizontal layout flex">
                                    <span class="tit num"> Date </span>
                                    <span class="name tit"> Name </span>
                                    <span class="tit num"> Found</span>
                                </div>
                                <div id="filterHistoryTable">
                                    <template is="dom-repeat" items="{{historyFilters}}">
                                        <div class="horizontal layout flex" on-click="loadFilter" data-filter="{{item.filter}}" title="{{item.name}}">
                                            <span class="num">{{item.date}} </span>
                                            <span id="filter-name" class="name">{{item.name}} </span>
                                            <span class="num">{{item.found}}</span>
                                        </div>
                                    </template>
                                </div>
                            </stv-tooltip> -->
                            <div class="stv-btn stv-btn-shdw flex" on-click="clearForm" style="margin-right: 3px;">
                                Clear
                            </div>
                            <div class="stv-btn stv-btn-shdw flex" on-click="submitForm">Search</div>
                        </div>
                        <!-- <div class="form_block positionBlock">
                            <div class="stv-formbox">
                                <div class="stv-formtitle">
                                    Position
                                </div>
                                <div class="stv-formcontent">
                                    <div class="input_container vertical layout">
                                        <label class="stv">Chromosomal Location:</label>
                                        <textarea id="region" name="region" placeholder="1:1-100000,2:1-100000" value="{{regionValue::change}}" rows="3"></textarea>
                                    </div>
                                    <div class="input_container vertical layout">
                                        <label class="stv">Gene:</label>
                                        <textarea id="gene" name="gene" placeholder="BRCA2,PPL" on-keyup="geneChanged" value="{{geneValue::change}}" rows="3"></textarea>

                                        <div class="searchGene horizontal layout end-justified">
                                            <input id="searchField" list="searchDataList" placeholder="Search gene" type="text" style="width: 100px;">
                                            <datalist id="searchDataList"></datalist>
                                            <div id="quickSearchButton" class="button" style="border-left: none;">
                                                <font-awesome icon="search"></font-awesome>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> -->
                        <stv-filter-position id="filterPosition"></stv-filter-position>
                        <stv-form-box>
                            <div class="header horizontal layout flex">
                                <div>Subpopulations</div>
                                <div class="flex"></div>
                                <div on-click="selectAllDiseases">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllDiseases">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="diseases_div">
                                    <template is="dom-repeat" items="{{diseases}}">
                                        <label class="stv-control">
                                            <input type="checkbox" class="diseaseName" name="disease" id="disease" value="{{item.groupId}}" checked/>
                                            <span>{{item.name}}</span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </stv-form-box>
                        <stv-form-box>
                            <div class="header horizontal layout flex">
                                <div>Technologies</div>
                                <div class="flex"></div>
                                <div on-click="selectAllTechnologies">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllTechnologies">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="technologies_div">
                                    <template is="dom-repeat" items="{{technologies}}">
                                        <label class="stv-control">
                                            <input type="checkbox" class="technologyName" name="technology" id="technology" value="{{item.technologyId}}" checked/>
                                            <span>{{item.name}}</span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </stv-form-box>
                    </div>
                </form>
            </div>
            <div id="dataGridElement" class="vertical layout" hidden$="{{saturation}}">
                <stv-table id="dataTable" enable-loading enable-paging enable-remote enable-select enable-resize request="{{request}}" columns="{{columns}}" on-rowclick="handleRowClick">
                    <div class="custom-buttons horizontal layout">
                        <button style="margin-right: 10px; color: #006699" id="saveTable" class="stv-btn down" on-click="downloadFiles" data-file="{{cnv}}"><i class="fa fa-cloud-download"></i> save</button>
                    </div>
                </stv-table>

                <div id="menu" class="color-2 color-hover-2 horizontal layout">
                    <div on-click="handleMenuClick" data-option="gv">Genomic context</div>
                    <div on-click="handleMenuClick" data-option="frequency">Frequencies</div>
                    <div on-click="handleMenuClick" data-option="phenotype">Phenotype</div>
                    <div on-click="handleMenuClick" data-option="effect">Effect</div>
                </div>

                <div id="tools" class="horizontal layout flex">
                    <jso-genome-viewer-element id="gv" class="tool" on-created="handleGenomeViewerCreated"></jso-genome-viewer-element>
                    <stv-variant-frequencies id="frequency" hidden class="tool"></stv-variant-frequencies>
                    <stv-variant-phenotype id="phenotype" hidden class="tool"></stv-variant-phenotype>
                    <stv-variant-effect id="effect" hidden class="tool"></stv-variant-effect>
                </div>
            </div>
            <div id="saturationDiv" hidden$="{{!saturation}}" class="vertical layout">
                <div id="chart" class="horizontal layout center-justified"></div>
            </div>
        </div>

    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-search-element',
        properties: {
            diseases: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: 'diseasesChanged'
            },
            technologies: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            regionValue: {
                type: String,
                value: ""
            },
            columns: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            formURL: {
                type: String,
                value: "",
                observer: 'urlChanged'
            },
            floatDecimals: {
                type: Number,
                value: 3
            },

            selectedMenuTool: {
                type: Object,
                observer: 'selectedMenuChanged'
            },
            geneValue: {
                type: String,
                value: ""
            },
            hidden: {
                type: Boolean,
                reflectToAttribute: true,
                observer: 'hiddenChanged',
                nofity: true
            },
            maxLength: {
                type: Number,
                value: 1000000
            },
            isLogged: {
                type: Boolean
            },
            historyFilters: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,

            },
            // hash: {
            //     type: Object,
            //     value: function() {
            //         return {};
            //     },
            // },
            numTotalResults: {
                type: Object,
                observer: "resultsChanged"
            },
            query: {
                type: Object,
                notify: true,
                value: function() {
                    return {};
                }
            },
            saturation: {
                type: Boolean,
                value: false
            }
            // request: {
            //     type: Object
            // },
        },

        resultsChanged: function(neo, old) {
            return;
            if (neo != -1) {
                var query = this.query;
                var numTotalResults = neo;
                /* Filter History */

                // var filterHistory = [];
                // if (this.jobId in this.hash) {
                // filterHistory = this.hash[this.jobId];
                // }

                // this.set("historyFilters", filterHistory);

                var newFilter = JSON.stringify(query);
                var _load = -1;
                for (var i = 0; i < this.historyFilters.length && _load == -1; i++) { // Check if the fitler has been selected from the history
                    var elem = this.historyFilters[i];
                    if (elem != null) {
                        var oldFilter = JSON.stringify(this.historyFilters[i].filter);
                        if (newFilter == oldFilter) {
                            _load = i;
                        }
                    }
                }

                if (_load == -1) { // This filter is new (has not been selected from the history)
                    if (query.regions != null && query.diseases != null) {
                        var dateAux = new Date();
                        var minAux = dateAux.getMinutes();
                        if (minAux < 10) {
                            minAux = "0" + minAux;
                        }
                        var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;
                        name = this.loadForm(query);
                        // var found = this.filterData.length;
                        var found = numTotalResults;
                        var hf = {};
                        hf = {
                            date: date,
                            name: name,
                            filter: query,
                            found: found
                        };

                        // var filters = new FilterHistory(5, filterHistory);
                        var filters = new FilterHistory(5, this.historyFilters);
                        filters.unshift(hf);
                        this.set("historyFilters", filters);

                        localStorage.csvs_filter_history = JSON.stringify(this.historyFilters);
                    }
                } else { // HistoryFilter contains this filter. We need to change the date and push to top
                    var pos = _load;

                    var filters = new FilterHistory(5, this.historyFilters);
                    var filter = filters[pos];
                    var dateAux = new Date();
                    var minAux = dateAux.getMinutes();
                    if (minAux < 10) {
                        minAux = "0" + minAux;
                    }
                    var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;

                    filter.date = date;

                    var aux = filters[pos];
                    filters[pos] = filters[0];
                    filters[0] = aux;

                    this.set("historyFilters", filters);
                    // this.hash[this.jobId] = this.historyFilters;
                    localStorage.csvs_filter_history = JSON.stringify(this.historyFilters);
                }
            }

        },

        geneChanged: function(e) {
            var target = e.currentTarget;
            var value = target.value;
            var splits = value.split(",");
            if (splits.length > 3 && !this.isLogged) {
                alert("The maximum number of genes is 3");
            }
        },
        hiddenChanged: function(neo, old) {

            if (!neo && this.selectedMenuTool) {
                this.$.gv.removeAttribute("hidden");
            }
        },
        created: function() {
            this.selectedSpecies = DEFAULT_SPECIES;
        },
        ready: function() {
            if (localStorage.csvs_filter_history) {
                this.historyFilters = JSON.parse(localStorage.csvs_filter_history);

            }

            var me = this;
            this.species = 'Homo sapiens';
            var lastQuery = '';
            this.geneValue = "PPL";

            this.async(function() { // DOM READY
                me.selectedMenuTool = me.$.menu.querySelector('div');
                me.$.gv.createGenomeViewer();
                me.$.gv.genomeViewer.draw();

            }, 50);

            this.columns = [{
                    name: 'chromosome',
                    title: "Chr",
                    width: 40
                }, {
                    name: 'position',
                    title: 'Position',
                    width: 70
                }, {
                    name: 'alleles',
                    title: 'Alleles',
                    width: 50,
                    formula: function(row) {
                        return row.reference + ">" + row.alternate;
                    }
                }, {
                    name: 'genes',
                    title: 'Gene',
                    width: 90,
                    defaultValue: "."
                }, {
                    name: 'id',
                    title: 'Id',
                    width: 90,
                    defaultValue: "."
                }, {
                    title: 'MAF',
                    name: 'maf',
                    width: 350,
                    columns: [{
                        title: "Genotypes",
                        name: 'genotypes',
                        width: 200,
                        columns: [{
                            name: "gt00",
                            width: 50,
                            title: "0/0",
                            formula: function(row) {
                                if (row.stats != null && row.stats.gt00 != null)
                                    return row.stats.gt00;
                                else
                                    return ".";
                            }
                        }, {
                            name: "gt01",
                            width: 50,
                            title: "0/1",
                            formula: function(row) {
                                if (row.stats != null && row.stats.gt01 != null)
                                    return row.stats.gt01;
                                else
                                    return ".";
                            }
                        }, {
                            name: "gt11",
                            width: 50,
                            title: "1/1",
                            formula: function(row) {
                                if (row.stats != null && row.stats.gt11 != null)
                                    return row.stats.gt11;
                                else
                                    return ".";
                            }
                        }, {
                            name: "gtmissing",
                            width: 50,
                            title: "./.",
                            formula: function(row) {
                                if (row.stats != null && row.stats.gtmissing != null)
                                    return row.stats.gtmissing;
                                else
                                    return ".";
                            }
                        }]
                    }, {
                        title: "Freq.",
                        name: "freq",
                        width: 150,
                        columns: [{
                            name: "refFreq",
                            width: 50,
                            title: "0 Freq",
                            formula: function(row) {
                                if (row.stats != null && row.stats.refFreq != null)
                                    return row.stats.refFreq;
                                else
                                    return ".";
                            }
                        }, {
                            name: "altFreq",
                            width: 50,
                            title: "1 Freq",
                            formula: function(row) {
                                if (row.stats != null && row.stats.altFreq != null)
                                    return row.stats.altFreq;
                                else
                                    return ".";
                            }
                        }, {
                            name: "maf",
                            width: 50,
                            title: "MAF",
                            formula: function(row) {
                                if (row.stats != null && row.stats.maf != null)
                                    return row.stats.maf;
                                else
                                    return ".";
                            }
                        }]
                    }]
                }, {
                    title: "1000G MAF (phase 1)",
                    width: 250,
                    name: 'maf1000g',
                    visible: false,
                    columns: [{
                            name: "maf1000G",
                            title: "ALL",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.maf1000G != null) {
                                    return row.maf1000G;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "maf1000GAME",
                            title: "AME",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.maf1000GAME != null) {
                                    return row.maf1000GAME;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "maf1000GASI",
                            title: "ASI",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.maf1000GASI != null) {
                                    return row.maf1000GASI;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "maf1000GAFR",
                            title: "AFR",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.maf1000GAFR != null) {
                                    return row.maf1000GAFR;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "maf1000GEUR",
                            title: "EUR",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.maf1000GEUR != null) {
                                    return row.maf1000GEUR;
                                } else {
                                    return ".";
                                }
                            }
                        }

                    ]
                }, {
                    title: "1000G MAF (phase 3)",
                    width: 150,
                    name: 'maf1000G3',
                    columns: [{
                        name: "maf1000G_PHASE_3_ALL",
                        title: "ALL",
                        defaultValue: ".",
                        formula: function(row) {
                            if (row.maf1000G_PHASE_3_ALL != null) {
                                return row.maf1000G_PHASE_3_ALL;
                            } else {
                                return ".";
                            }
                        }
                    }, {
                        name: "maf1000G_PHASE_3_AMR",
                        title: "AME",
                        defaultValue: ".",
                        visible: false,
                        formula: function(row) {
                            if (row.maf1000G_PHASE_3_AMR != null) {
                                return row.maf1000G_PHASE_3_AMR;
                            } else {
                                return ".";
                            }
                        }
                    }, {
                        name: "maf1000G_PHASE_3_SAS",
                        title: "South ASI",
                        defaultValue: ".",
                        visible: false,
                        formula: function(row) {
                            if (row.maf1000G_PHASE_3_SAS != null) {
                                return row.maf1000G_PHASE_3_SAS;
                            } else {
                                return ".";
                            }
                        }
                    }, {
                        name: "maf1000G_PHASE_3_EAS",
                        title: "East ASI",
                        defaultValue: ".",
                        visible: false,
                        formula: function(row) {
                            if (row.maf1000G_PHASE_3_EAS != null) {
                                return row.maf1000G_PHASE_3_EAS;
                            } else {
                                return ".";
                            }
                        }
                    }, {
                        name: "maf1000G_PHASE_3_AFR",
                        title: "AFR",
                        defaultValue: ".",
                        visible: false,
                        formula: function(row) {
                            if (row.maf1000G_PHASE_3_AFR != null) {
                                return row.maf1000G_PHASE_3_AFR;
                            } else {
                                return ".";
                            }
                        }
                    }, {
                        name: "maf1000G_PHASE_3_EUR",
                        title: "EUR",
                        defaultValue: ".",
                        formula: function(row) {
                            if (row.maf1000G_PHASE_3_EUR != null) {
                                return row.maf1000G_PHASE_3_EUR;
                            } else {
                                return ".";
                            }
                        }
                    }, ]

                }, {
                    title: "ExAC",
                    width: 50,
                    name: 'mafexac',
                    columns: [{
                            name: "mafexac_ALL",
                            title: "ALL",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.mafexac_ALL != null) {
                                    return row.mafexac_ALL;
                                } else {
                                    return ".";
                                }
                            }
                        }
                        //                    , {
                        //                    name: "mafexac_EUR",
                        //                    title: "EUR",
                        //                    defaultValue: ".",
                        //                    formula: function (row) {
                        //                        if (row.mafexac_EUR != null) {
                        //                            return row.mafexac_EUR;
                        //                        } else {
                        //                            return ".";
                        //                        }
                        //                    }
                        //                }
                    ]
                },

                {
                    title: "ESP 6500",
                    width: 100,
                    name: 'maf6500',
                    columns: [{
                            name: "mafESP_ALL",
                            title: "ALL",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.mafESP_ALL != null) {
                                    return row.mafESP_ALL;
                                } else {
                                    return ".";
                                }
                            }
                        }, {
                            name: "mafESP_EA",
                            title: "Eur. Ame.",
                            defaultValue: ".",
                            formula: function(row) {
                                if (row.mafESP_EA != null) {
                                    return row.mafESP_EA;
                                } else {
                                    return ".";
                                }
                            }
                        }
                        //                        , {
                        //                        name: "mafESP_AA",
                        //                        title: "Afr. Ame.",
                        //                        defaultValue: ".",
                        //                        formula: function (row) {
                        //                            if (row.mafESP_AA != null) {
                        //                                return row.mafESP_AA;
                        //                            } else {
                        //                                return ".";
                        //                            }
                        //                        }
                        //                    }
                    ]
                }, {
                    name: 'sift',
                    title: 'SIFT',
                    width: 50
                }, {
                    name: 'polyphen',
                    title: 'Polyphen',
                    width: 60
                }, {
                    name: 'phastcons',
                    title: 'PhastCons',
                    width: 60
                }, {
                    name: 'phylop',
                    title: 'phyloP',
                    width: 50
                }, {
                    name: 'gerp',
                    title: 'GERP',
                    width: 50
                }, {
                    name: 'cadd',
                    title: 'CADD',
                    width: 50
                }, {
                    name: 'phenotypes',
                    title: 'Phenotypes',
                    width: 450,
                    columns: [{
                        name: 'clinvar',
                        title: 'Clinvar',
                        width: 150,
                        formula: function(row) {
                            try {
                                return row.phenotypes.clinvar;
                            } catch (e) {
                                return ".";
                            }
                        }
                    }, {
                        name: 'cosmic',
                        title: 'Cosmic',
                        width: 150,
                        formula: function(row) {
                            try {
                                return row.phenotypes.cosmic;
                            } catch (e) {
                                return ".";
                            }

                        }
                    }, {
                        name: 'gwas',
                        title: 'GWas',
                        width: 150,
                        formula: function(row) {
                            try {
                                return row.phenotypes.gwas;
                            } catch (e) {
                                return ".";
                            }

                        }
                    }]
                }
            ];
            this.reloadChart({});
        },
        downloadFiles: function(e) {
            this.query.limit = 0;
            var me = this;
            var url = CSVSManager.variants.fetch({
                query: this.query,
                request: {
                    success: function(r) {
                        var stringToSave = "";
                        //me.parseJson(r.result);
                        for( var i = 0; i < r.result.length; i++){
                            stringToSave = stringToSave + me._csvToString(r.result[i]);
                        }
                        var blob = new Blob([stringToSave], {
                            type: "text/plain;charset=utf-8"
                        });
                        saveAs(blob, "csvs.bed");
                        //console.log(stringToSave);
                    },
                    error:function(r){
                        console.log("error in save");
                    }
                },
            });
        },
        _csvToString: function(o){
            return  "chr" + o.chromosome + "\t" + o.position + "\t" + o.reference + ">" + o.alternate +
                    "\t" + o.stats.gt00 + "\t" + o.stats.gt01 + "\t" + o.stats.gt11 +"\t" +
                    o.stats.gtmissing + "\t" + o.stats.refFreq + "\t" + o.stats.altFreq + "\t"+ o.stats.maf +"\n";
        },
        _toFixed: function(value, precision) {
            return Number(value).toFixed(precision);
        },
        _setQuickSearchMenu: function(query) {

            while (this.$.searchDataList.firstChild) {
                this.$.searchDataList.removeChild(this.$.searchDataList.firstChild);
            }
            this.quickSearchDataset = {};
            var items = this._quickSearchResultFn(query);
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var value = item["name"];
                this.quickSearchDataset[value] = item;
                var menuEntry = document.createElement('option');
                menuEntry.setAttribute('value', value);
                this.$.searchDataList.appendChild(menuEntry);
            }

        },
        _quickSearchResultFn: function(query) {
            var results = [];
            var speciesCode = stv.utils.getSpeciesCode(this.species);

            CellBaseManager.get({
                host: CELLBASE_HOST,
                version: CELLBASE_VERSION,
                species: speciesCode,
                category: 'feature',
                subCategory: 'id',
                query: query,
                resource: 'starts_with',
                params: {
                    limit: 10
                },
                async: false,
                success: function(data, textStatus, jqXHR) {
                    results = data.response[0].result;
                }
            });
            return results;
        },
        submitForm: function() {

            var me = this;
            var query = {};


            var regionValue = this.$.filterPosition.checkRegion();
            if (regionValue == -1) {
                return;
            }

            var geneValue = this.$.filterPosition.checkGene();

            // if (this.$.filter_form.checkValidity() && (regions != null || genes != null)) {
            // if (this.$.filter_form.checkValidity()) {

            var regions = [];
            if (regionValue != null) {
                //     // check Regions)
                //     var aux = regionValue.split(",");
                //     var length = 0;
                //
                //     for (var i = 0; i < aux.length; i++) {
                //         var region = aux[i].trim();
                //         var r = new Region(region);
                //
                //         if (r.chromosome == null || r.start == null || r.end == null) {
                //             alert("Malformed region: " + region);
                //             return;
                //         } else if (r.start > r.end) {
                //             alert("Start must be lower or equal than End: " + region);
                //             return;
                //         } else {
                //             length += (r.end - r.start);
                //             regions.push(r.toString());
                //         }
                //     }

                regions = regionValue.split(",");
                if (regions.length > this.maxLength && !this.isLogged) {
                    alert("The total size of all provided regions can't exceed " + this.maxLength + " positions");
                    return
                }
            }

            var genes = [];
            if (geneValue != null) {

                genes = geneValue.split(",");
                for (var i = 0; i < genes.length; i++) {
                    genes[i] = genes[i].trim();
                }

                if (genes.length > 3 && !this.isLogged) {
                    alert("The maximum number of genes is 3");
                    return;
                }

                var gene = genes.join(",").toUpperCase();

                var regionGene = {};

                CellBaseManager.get({
                    species: 'hsapiens',
                    category: 'feature',
                    subCategory: 'gene',
                    query: gene,
                    resource: "info",
                    async: false,
                    params: {
                        include: 'chromosome,start,end'
                    },
                    success: function(data) {
                        for (var i = 0; i < data.response.length; i++) {
                            var queryResult = data.response[i];

                            if (queryResult.result.length > 0) {
                                var region = new Region(queryResult.result[0]);
                                regionGene[region] = queryResult.id;
                                regions.push(region.toString());

                            } else {
                                alert("Wrong gene: " + gene);
                            }
                        }
                    }
                });
            }

            var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
            var diseaseIds = [];


            for (var i = 0; i < diseaseEls.length; i++) {
                var el = diseaseEls[i];
                if (el.checked) {
                    diseaseIds.push(el.getAttribute("value"));
                }
            }


            var technologyEls = this.$.technologies_div.querySelectorAll(".technologyName");
            var technologyIds = [];

            for (var i = 0; i < technologyEls.length; i++) {
                var el = technologyEls[i];
                if (el.checked) {
                    technologyIds.push(el.getAttribute("value"));
                }
            }

            if (regions.length > 0) {
                var regionQuery = regions.join(",");
                query.regions = regionQuery;
                query.diseases = diseaseIds.join(",");
                query.technologies = technologyIds.join(",");
                query.skipCount = false;

                CSVSManager.regions.saturation({
                    id: regionQuery,
                    query: query,
                    request: {
                        // host: "http://aaleman:8080/csvs/rest",
                        success: function(response) {

                            var data = response.result[0];

                            for (var region in regionGene) {
                                if (region in data) {
                                    var newKey = regionGene[region];
                                    data[newKey] = data[region];
                                    delete data[region];
                                }
                            }
                            try {

                                me.reloadChart(data);
                            } catch (e) {
                                me.reloadChart({});
                            }

                        }
                    }
                });

                var url = CSVSManager.variants.fetch({
                    query: query,
                    request: {
                        url: true
                    }
                });

                this.formURL = url;
            }
            if (regions.length == 0 && genes.length == 0) {
                alert("Please add a region/gene and check any subpopulation/technology");
            }

            query.gene = geneValue;
            this.set('query', query);

        },
        _formatText: function(text) {
            return stv.utils.formatText(text, "_").toLowerCase().replace(/(?:^|\s)\S/g, function(a) {
                return a.toUpperCase();
            });
        },
        clearForm: function() {

            this.$.filter_form.reset();
            this.$.filterPosition.clear();

        },
        loadForm: function(hf) {
            var filterName = [];
            var hfAux = hf;
            if (hf.regions != "" && hf.regions != null) {
                hfAux.region = hf.regions;
            }
            var fP = this.$.filterPosition.load(hfAux);
            if (fP.length > 0) {
                for (var i = 0; i < fP.length; i++) {
                    filterName.push(fP[i]);
                }
            }

            if (hf.diseases != "" && hf.diseases != null) {
                var disName = [];
                var dis = hf.diseases.split(",");
                var aux = this.$.diseases_div.querySelectorAll("input");
                for (var i = 0; i < aux.length; i++) {
                    aux[i].checked = false;
                }
                for (var i = 0; i < dis.length; i++) {
                    for (var j = 0; j < aux.length; j++) {
                        var id = aux[j].value;
                        if (dis[i] == id) {
                            aux[j].checked = true;
                            for (var k = 0; k < this.diseases.length; k++) {
                                if (id == this.diseases[k].groupId) {
                                    disName.push(this.diseases[k].name);
                                }
                            }
                        }
                    }
                }
                filterName.push("Disease: " + disName.join(",") + " ");
            }
            return filterName.join(" AND ");
        },
        loadFilter: function(e) {
            e.stopPropagation();
            this.clearForm();
            this.loadForm(e.currentTarget.dataFilter);
            this.$.filterHistoryTooltip.handleClose(e);
            this.submitForm();
        },
        clearFiltersHistory: function(e) {
            e.stopPropagation();
            this.historyFilters = [];
            localStorage.csvc_filter_history = JSON.stringify(this.historyFilters);

        },
        exportQueryToCSV: function() {
            var numVariants = this.$.dataGrid.dataSize;

            if (numVariants > 200) {
                alert("Sorry, you are trying to export a CSV with more than 200 Variants. Please restrict your query, the maximum allowed variants are 200.");
                return;
            }

            var me = this;
            if (this.formUrl != "") {
                var url = this.formURL + "&csv=true";

                $.ajax({
                    url: url,
                    dataType: 'json',
                    async: false,
                    success: function(response, textStatus, jqXHR) {
                        if (response != undefined && response.result.length > 0) {

                            var data = response.result; // TODO aaleman: Fix this!

                            // var finalData = me.parseFunction(data);

                            // Create CSV

                            var csvData = [
                                ['chromosome', 'position', 'ref', 'alt', 'snpId', 'MAF', '1000G MAF', 'EVS MAF'].join(";")
                            ];

                            for (var i = 0; i < finalData.length; i++) {
                                var row = finalData[i];
                                var maf1000G = '.';
                                var mafEVS = '.';
                                if (row.maf1000G) {
                                    maf1000G = row.maf1000G;
                                }
                                if (row.mafEVS) {
                                    mafEVS = row.mafEVS;
                                }

                                csvData.push([
                                    row.chromosome,
                                    row.position,
                                    row.reference,
                                    row.alternate,
                                    row.id,
                                    row.stats.maf,
                                    maf1000G,
                                    mafEVS

                                ].join(";"))
                            }

                            var csvString = csvData.join("%0A");

                            var a = document.createElement('a');
                            a.href = 'data:text/csv,' + csvString;
                            a.target = '_blank';
                            a.download = 'variants.csv';

                            a.click();
                        }

                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log('Error exporting to CSV');
                    }
                });
            }
        },
        selectAllDiseases: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("diseaseName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        selectAllTechnologies: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("technologyName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        deselectAllDiseases: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("diseaseName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        },
        deselectAllTechnologies: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("technologyName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        },
        urlChanged: function(neo, old) {

            // debugger
            var me = this;
            // if (neo != '') {
            //     this.request = {
            //         url: this.formURL,
            //         parse: this._parse,
            //         parseTotal: this._parseTotal,
            //         file: this.file
            //     };
            // }
            if (neo == null || neo == "") {
                return;
            }
            this.request = {
                url: this.formURL,
                auxTotalCount: -1,
                parse: function(response) {
                    return me._parse(response);
                },
                parseTotal: function(response) {
                    var total = me._parseTotal(response);

                    me.numTotalResults = total;

                    if (this.auxTotalCount == -1) {

                        this.auxTotalCount = total;

                        this.url = this.url.replace("&skipCount=false", "&skipCount=true");

                    } else {
                        me.numTotalResults = this.auxTotalCount;
                        total = me.numTotalResults;
                    }

                    me.set('numTotalResults', -1);
                    me.set('numTotalResults', total);
                    return total;
                },
            };

        },
        _parse: function(response) {

            var me = this;
            var data = response.result;
            var positions = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];

                var variant = row.chromosome + ":" + row.position + ":" + row.reference + ":" + row.alternate;
                positions.push(variant);

            }

            // Annotate
            var query = positions.join(",");
            if (positions.length > 0) {

                CellBaseManager.get({
                    host: CELLBASE_HOST,
                    version: CELLBASE_VERSION,
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'variant',
                    resource: 'annotation',
                    query: query,
                    async: false,
                    success: function(response) {
                        try {
                            var annotData = response.response;
                            for (var i = 0; i < annotData.length; i++) {
                                var obj = annotData[i];
                                if (obj.result.length > 0) {
                                    var annots = obj.result[0];
                                    data[i].annots = annots;
                                }
                            }
                        } catch (e) {}
                    },
                    error: function(e) {
                        // debugger
                    }
                });
            }

            for (var i = 0; i < data.length; i++) {
                var variant = data[i];


                if (variant.annots == null) {
                    continue;
                }

                // Annotate SNPid
                if (variant.annots.id != null && variant.annots.id) {
                    variant.id = variant.annots.id;
                }

                // Annotate Cons
                if (variant.annots.conservation != null && variant.annots.conservation.length > 0) {

                    for (var j = 0, l = variant.annots.conservation.length; j < l; j++) {
                        var crs = variant.annots.conservation[j];
                        if (crs) {
                            score = crs.score.toFixed(3)
                            switch (crs.source.toLowerCase()) {
                                case 'phastcons':
                                    variant.phastcons = score;
                                    break;
                                case 'phylop':
                                    variant.phylop = score;
                                    break;
                                case 'gerp':
                                    variant.gerp = score;
                                    break;
                                default:
                            }
                        }
                    }
                }


                // Annotate CT && Subs. Score
                if (variant.annots.consequenceTypes != null && variant.annots.consequenceTypes.length > 0) {

                    var sif = -1;
                    var sifDesc = "";
                    var poly = -1;
                    var polyDesc = "";
                    var genes = [];

                    for (var j = 0, l = variant.annots.consequenceTypes.length; j < l; j++) {
                        var ct = variant.annots.consequenceTypes[j];
                        if (ct != null && ct != "undefined") {
                            if (ct.geneName != null && ct.geneName.length > 0 && genes.indexOf(ct.geneName) < 0) {
                                genes.push(ct.geneName);
                            }

                            if (ct.proteinVariantAnnotation != null && ct.proteinVariantAnnotation.substitutionScores != null && ct.proteinVariantAnnotation.substitutionScores.length > 0) {
                                var auxSift = null;
                                var auxPoly = null;
                                for (var k = 0, l = ct.proteinVariantAnnotation.substitutionScores.length; k < l; k++) {

                                    var pss = ct.proteinVariantAnnotation.substitutionScores[k];
                                    switch (pss.source.toLowerCase()) {
                                        case 'sift':
                                            auxSift = pss;
                                            break;
                                        case 'polyphen':
                                            auxPoly = pss;
                                            break;
                                    }
                                }

                                if (auxPoly != null && auxSift != null) {
                                    if (auxPoly.score > poly) {
                                        sif = auxSift.score;
                                        poly = auxPoly.score;

                                        sifDesc = auxSift.description;
                                        polyDesc = auxPoly.description;

                                    }
                                }
                            }
                        }
                    }
                    if (sif != -1 && poly != -1) {
                        variant.sift = sif;
                        variant.polyphen = poly;
                    }

                    if (genes.length > 0) {
                        variant.genes = genes.join(",");
                    }
                }


                // Functional Score
                if (variant.annots.functionalScore != null && variant.annots.functionalScore.length > 0) {
                    var cadd = null;
                    for (var j = 0; j < variant.annots.functionalScore.length; j++) {
                        var cadd_elem = variant.annots.functionalScore[j];
                        switch (cadd_elem.source.toLowerCase()) {
                            case 'cadd_raw':
                                cadd = cadd_elem.score.toFixed(3);
                                break;
                            case 'cadd_scaled':
                                break;
                        }
                    }
                    if (cadd != null) {
                        variant.cadd = cadd;
                    }
                }

                // Clinical
                variant.phenotypes = {
                    cosmic: "",
                    gwas: "",
                    clinvar: ""
                };

                if (variant.annots.variantTraitAssociation != null) {
                    var clinical = variant.annots.variantTraitAssociation;

                    var phenotypesCosmic = [];
                    var phenotypesGwas = [];
                    var phenotypesClinvar = [];
                    if (clinical.cosmic != null) {
                        for (var j = 0; j < clinical.cosmic.length; j++) {
                            var cosmic = clinical.cosmic[j];
                            if (cosmic.primaryHistology != null && cosmic.primaryHistology != "") {
                                phenotypesCosmic.push(cosmic.primaryHistology);
                            }
                        }
                    }

                    if (clinical.gwas != null) {
                        for (var j = 0; j < clinical.gwas.length; j++) {
                            var gwas = clinical.gwas[j];
                            for (var k = 0; k < gwas.traits.length; k++) {
                                var trait = gwas.traits[k];
                                if (trait != null && trait != "") {
                                    phenotypesGwas.push(trait);
                                }
                            }
                        }
                    }

                    if (clinical.clinvar != null) {
                        for (var j = 0; j < clinical.clinvar.length; j++) {
                            var clinvar = clinical.clinvar[j];
                            for (var k = 0; k < clinvar.traits.length; k++) {
                                var trait = clinvar.traits[k];
                                if (trait != null && trait != "") {
                                    phenotypesClinvar.push(trait);
                                }
                            }
                        }
                    }

                    var phenotypesCosmicFinal = phenotypesCosmic.filter(function(item, pos) {
                        return phenotypesCosmic.indexOf(item) == pos;
                    });
                    var phenotypesGwasFinal = phenotypesGwas.filter(function(item, pos) {
                        return phenotypesGwas.indexOf(item) == pos;
                    });
                    var phenotypesClinvarFinal = phenotypesClinvar.filter(function(item, pos) {
                        return phenotypesClinvar.indexOf(item) == pos;
                    });


                    variant.phenotypes = {
                        cosmic: phenotypesCosmicFinal.join(","),
                        gwas: phenotypesGwasFinal.join(","),
                        clinvar: phenotypesClinvarFinal.join(",")
                    };
                }

                if (variant.annots.populationFrequencies != null) {

                    for (var j = 0; j < variant.annots.populationFrequencies.length; j++) {

                        var pfreq = variant.annots.populationFrequencies[j];

                        if (pfreq.study.toLowerCase() === "1000genomes_phase_1") {
                            switch (pfreq.population) {
                                case "ALL":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G = Number(maf).toFixed(3)
                                    break;

                                case "AMR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GAME = Number(maf).toFixed(3)
                                    break;

                                case "ASN":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GASI = Number(maf).toFixed(3)
                                    break;

                                case "AFR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GAFR = Number(maf).toFixed(3)
                                    break;

                                case "EUR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GEUR = Number(maf).toFixed(3)
                                    break;
                            }
                        } else if (pfreq.study.toLowerCase() === "1000genomes_phase_3") {
                            switch (pfreq.population) {
                                case "ALL":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_ALL = Number(maf).toFixed(3)
                                    break;
                                case "SAS":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_SAS = Number(maf).toFixed(3)
                                    break;
                                case "EAS":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_EAS = Number(maf).toFixed(3)
                                    break;
                                case "AMR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_AMR = Number(maf).toFixed(3)
                                    break;
                                case "AFR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_AFR = Number(maf).toFixed(3)
                                    break;
                                case "EUR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_EUR = Number(maf).toFixed(3)
                                    break;

                            }
                        } else if (pfreq.study.toLowerCase() === "esp_6500") {
                            switch (pfreq.population) {
                                case "EA":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafESP_EA = Number(maf).toFixed(3)
                                    break;
                                case "AA":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafESP_AA = Number(maf).toFixed(3)
                                    break;
                                case "ALL":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafESP_ALL = Number(maf).toFixed(3)
                                    break;


                            }
                        } else if (pfreq.study.toLowerCase() === "exac") {
                            switch (pfreq.population) {
                                case "ALL":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafexac_ALL = Number(maf).toFixed(3)
                                    break;
                                case "EUR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafexac_EUR = Number(maf).toFixed(3)
                                    break;
                            }
                        }
                    }
                }


            }

            return data;
        },
        _parseTotal: function(response) {
            // return response.numTotalResults;
            if (response != null) {
                var total = response.numTotalResults;
            } else {
                total = 0;
            }
            return total;
        },
        handleRowClick: function(e) {
            var row = e.detail.row;

            this.$.gv.genomeViewer.setRegion(row);
            this.$.effect.row = row;
            this.$.frequency.row = row;
            this.$.phenotype.row = row;

        },
        handleMenuClick: function(e) {
            this.selectedMenuTool = e.currentTarget;
        },
        selectedMenuChanged: function(neo, old) {
            if (old) {
                old.removeAttribute('selected');
                this.$[old.dataset.option].setAttribute('hidden', '');
            }
            if (neo && !this.hidden) {
                neo.setAttribute('selected', '');
                this.$[neo.dataset.option].removeAttribute('hidden');
            }
        },
        handleGenomeViewerCreated: function() {
            var me = this;

            var adapter = new FeatureTemplateAdapter({
                uriTemplate: CSVS_HOST + '/regions/{region}/fetch',
                //                templateVariables: {
                //                    customVar: 'info',
                //                },
                species: this.$.gv.genomeViewer.species,
                //                getRegionsFromIntervals: function (response) {
                //
                //                    debugger
                //                    var regions = [];
                //                    for (var i = 0; i < response.result.length; i++) {
                //                        var r = response.result[i];
                //                        for (var j = 0; j < r.length; j++) {
                //                            var interval = r[j];
                //                            var region = new Region(interval);
                //                            regions.push(region);
                //                        }
                //                    }
                //                    return regions;
                //
                //                },
                parse: function(response) {
                    var itemsArray = [];

                    for (var i = 0; i < response.result.length; i++) {
                        var r = response.result[i];
                        for (var j = 0; j < r.length; j++) {
                            var elem = r[j];
                            elem.start = elem.position;
                            elem.end = elem.position;
                        }
                        itemsArray.push(r);
                    }

                    return itemsArray;
                },
                parseHistogram: function(response) {
                    //                    debugger
                    var itemsArray = [];
                    for (var i = 0; i < response.result.length; i++) {
                        var r = response.result[i]
                        for (var j = 0; j < r.length; j++) {
                            var interval = r[j];
                            interval.features_count = interval.featuresCount;
                            console.log(interval.features_count);
                            itemsArray.push(interval);
                        }
                    }
                    return itemsArray;
                }
            });

            var args = FEATURE_TYPES.undefined;
            args.handlers = {
                "feature:click": function(e) {

                    var elem = e.feature;
                    console.log(elem);

                    me.$.dataTable.selectElem(elem, function(x, y) {
                        return x.chromosome == y.chromosome && x.position == y.position &&
                            x.reference == y.reference && x.alternate == y.alternate;
                    });
                }
            }

            var track = new FeatureTrack({
                title: 'CSVS',
                featureType: 'csvs',
                minHistogramRegionSize: 12000,
                maxLabelRegionSize: 3000,
                height: 120,
                renderer: new FeatureRenderer(args),
                dataAdapter: adapter
            });

            this.$.gv.genomeViewer.addTrack(track);
        },
        diseasesChanged: function(neo, old) {

            if (neo && Array.isArray(neo)) {
                //                debugger
                var diseasesSort = [];
                var diseaseMap = {};
                var diseaseNameMap = {};

                for (var i = 0; i < neo.length; i++) {
                    diseasesSort.push(neo[i]);
                    diseaseMap[neo[i].groupId] = neo[i];
                    diseaseNameMap[neo[i].name] = neo[i];
                }

                diseasesSort.sort(function(a, b) {
                    return b.samples - a.samples;
                });
                this.diseasesSort = diseasesSort;
                this.diseaseMap = diseaseMap;
                this.diseaseNameMap = diseaseNameMap;
            }
        },
        _getDiseaseCount: function(data, disease) {
            var count = 0;

            for (var i = 0; i < data.length; i++) {
                var elem = data[i];
                if (elem.diseaseId == disease.groupId) {
                    count = elem.count;
                }
            }
            return count;
        },
        removeZeroValues: function(data) {
            var auxTable = [];

            for (key in data) {
                var row = data[key];
                auxTable.push(row);
            }

            if (auxTable.length > 0) {
                var len = auxTable[0].length;

                for (var j = 0; j < len; j++) {
                    var allZero = true;

                    for (var i = 0; i < auxTable.length && allZero; i++) {
                        if (auxTable[i][j].count != 0) {
                            allZero = false;
                        }

                    }

                    if (allZero) {
                        for (var i = 0; i < auxTable.length; i++) {
                            auxTable[i][j] = null;
                        }
                    }
                }

                for (key in data) {
                    data[key] = data[key].filter(function(row) {
                        return row != null;
                    })
                }
            }
        },
        reloadChart: function(data) {

            var me = this;
            var chartData = [];

            var diseaseBreaks = [];
            var diseaseBreaksCheck = false;

            this.removeZeroValues(data);

            for (var key in data) {
                var diseaseData = data[key];

                if (!diseaseBreaksCheck) {
                    diseaseBreaksCheck = true;
                    diseaseBreaks = Array(diseaseData.length).fill(0);
                    var totalSample = 0;
                    for (var i = 0; i < diseaseData.length; i++) {
                        var elem = diseaseData[i];
                        totalSample += elem.samples;
                        diseaseBreaks[i] = elem.samples;
                    }
                    for (var i = 0; i < diseaseBreaks.length; i++) {
                        var value = Math.floor((diseaseBreaks[i] / totalSample) * 50);
                        diseaseBreaks[i] = {
                            from: i,
                            to: i,
                            breakSize: value
                        }
                    }
                    diseaseBreaks.unshift({
                        from: 0,
                        to: 0,
                        breakSize: 0
                    });
                }
                var counts = [];

                var labels = [];
                var total = 0;
                var j = 0;
                for (var i = 0; i < diseaseData.length; i++) {
                    var elem = diseaseData[i];
                    var dis = this.diseaseMap[elem.diseaseId];
                    if (dis.samples == 0) {
                        continue;
                    }

                    labels.push(dis.name);
                    counts.push({
                        y: elem.count,
                        _count: elem.count,
                        _samples: dis.samples
                    });

                    total += elem.count;
                }

                for (var i = 1; i < counts.length; i++) {
                    counts[i].y += counts[i - 1].y;
                }
                for (var i = 0; i < counts.length; i++) {
                    counts[i].radius = counts[i]._count / 5; //1/(counts[i]._count)
                }

                labels.unshift(
                    ""
                );
                counts.unshift({
                    y: 0
                });

                chartData.push({
                    name: key,
                    data: counts,
                    // connectNulls: true
                });
                console.log(chartData);
            }

            var chart = new Highcharts.Chart({
                _me: me,
                chart: {
                    type: 'line',
                    plotBackgroundColor: null,
                    plotBorderWidth: 1, //null,
                    plotShadow: false,
                    renderTo: this.$.chart,
                    borderRadius: 10,
                    width: 1000,
                    height: 700,
                    pointStart: 0,
                    _me: me
                },
                exporting: {},
                title: {
                    text: "Saturation"
                },
                tooltip: {
                    //                    shared: true,
                    //                    backgroundColor: '#FCFFC5',
                    //                    borderColor: 'black',
                    //                    borderRadius: 10,
                    //                    borderWidth: 3,
                    useHTML: true,
                    formatter: function() {
                        //                        debugger
                        var point = this.point;
                        return ' Disease Group: <b>' + this.x + '</b><br> New Variants: <b>' + point._count + '</b> <br> Acum. Variants: <b>' + this.y + '</b></br>Samples: <b>' + point._samples + '</b>';

                    }
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    categories: labels,
                    tickInterval: 1,
                    breaks: diseaseBreaks,
                    labels: {
                        rotation: 335
                            // y: 100,
                    },
                    // tickPositions: diseaseTick
                },
                yAxis: {
                    title: {
                        text: 'Num. variants'
                    },
                    min: 0,
                    startOnTick: true
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: chartData
            });
        }
    });
</script>
