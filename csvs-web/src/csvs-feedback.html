<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/stevia-elements/src/stv-dialog/stv-dialog.html">

<dom-module id="csvs-feedback">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
         :host {
            display: block;
            position: relative;
            box-sizing: border-box;
        }

        #emailPanel {
            width: 500px;
            /*height: 500px;*/
            min-width: 500px;
            /*min-height: 500px;*/
        }

        #emailContent {
            padding: 20px;
        }

        .send {
            width: 100px;
            margin-top: 20px;
        }

        textarea {
            box-sizing: border-box;
            width: 100%;
            height: 300px;
            resize: none;
        }
    </style>
    <template>
        <stv-panel id="emailPanel" modal fixed closable on-close="handleFeedback">

            <div class="header">
                <i class="fa fa-envelope-o"></i> Send an email
            </div>
            <div id="emailContent" class="container flex">
                <form id="iron-form" action ="mailto:sgaort@gmail.com">
                <div class="horizontal layout">
                    <div class="flex">
                        <label class="stv" for="">Subject:</label>
                        <input class="stv" type="text" value="{{subject::input}}" />
                    </div>
                    <div style="margin-left:15px;">
                        <label class="data" for="">Type:</label>
                        <stv-select id="emailType" style="width:150px; margin-top:5px">
                            <stv-option value="suggest">Suggest</stv-option>
                            <stv-option value="question">Question</stv-option>
                            <stv-option value="error">Error</stv-option>
                        </stv-select>
                    </div>
                </div>
                 <br>
                 <label class="stv" for="">From:</label>
                 <input class="stv" type="email" id="email" value="{{email::input}}" placeholder="name@example.com">
                 <br>
                <label class="stv" for="">Text:</label>
                <textarea class="stv flex" name="" id="" cols="30" rows="10" value="{{text::input}}" required></textarea>
                <br>
                <div class="horizontal layout center end-justified">
                    <div id="Sending" hidden$="{{!sending}}">
                        <i class="fa fa-circle-o-notch fa-spin"></i> Sending...
                    </div>
                    <div id="messagemail">{{message}}&nbsp;</div>
                    <div class="stv-btn stv-btn-shdw stv-btn-big" on-click="validateForm">&nbsp; Send</div>
                </div>
                </form>
            </div>

        </stv-panel>
    </template>

    <script>
        Polymer({
            is: "csvs-feedback",
            properties: {
                subject: {
                    type: String,
                    value: ""
                },
                email: {
                    type: String,
                    value: ''
                },
                text: {
                    type: String,
                    value: ""
                },
                sending: {
                    type: Boolean,
                    value: false
                },
                hidden: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    observer: 'hiddenChanged'
                }
            },
            validateForm: function(){
                var me = this;
                var email = this.email;
                var text = this.text.trim();
                var msj = "";

                // Check mail
                if (!_.isEmpty(email))
                    if (!/^(?:[^<>()[\].,;:\s@"]+(\.[^<>()[\].,;:\s@"]+)*|"[^\n"]+")@(?:[^<>()[\].,;:\s@"]+\.)+[^<>()[\]\.,;:\s@"]{2,63}$/i.test(email))
                        msj = msj + 'Invalid email format. ';

                // check text
                if (_.isEmpty(text))
                    msj = msj + 'Please, add a text to the message. ';

                if (!_.isEmpty(msj)) {
                    new StvDialog().alert(msj);
                } else {
                    if (_.isEmpty(email))
                        new StvDialog().confirm("The field 'From' is not filled in!.  Click 'Cancel' and fill out your email if you want to receive a reply or press 'Ok' if you want to leave this field empty.", function(answer) {
                            console.log(answer);
                            if (answer == true)
                                me.submitForm(me);
                        });
                    else
                        me.submitForm(me);
                }
            },
            submitForm: function (me) {
                var subject = me.subject;
                var emailType = me.$.emailType.selectedOptionText;
                var email = me.email;
                var text = me.text.trim();

                me.sending = true;
                me.message = "";

                $.ajax({
                    url: window.URL_MAIL,
                    data: {
                        subject: emailType + ':' + subject,
                        text: text,
                        html: '<pre>'+text+'</pre>',
                        from: email || window.FROM_EMAIL || '',
                        to: window.TO_EMAIL || '',
                        host: window.HOST || '',
                        port: window.PORT || '',
                        secure: window.SECURE,
                        debug: window.DEBUG,
                        ignoreTLS: window.IGNORE_TLS,
                        user: window.USER,
                        pass: window.PASS
                    },
                    dataType: "json",
                    contentType: 'application/json',
                    crossDomain: true,
                    success: function (data) {
                        if (data && data.data === "sent") {
                            me.sending = false;
                            me.message = 'Sent message';
                            document.getElementById("messagemail").style = "color:green";
                        } else {
                            me.sending = false;
                            me.message = 'There has been a problem with the SMTP server';
                            document.getElementById("messagemail").style = "color: #bf4747";
                            new StvDialog().alert('There has been a problem with the SMTP server, try again later');
                        }
                    },
                    error: function () {
                        me.sending = false;
                        me.message = 'There was an error sending an email';
                        document.getElementById("messagemail").style = "color: #bf4747";
                        new StvDialog().alert("There was an error sending an email, try again later");
                    },
                    type: "POST"
                }); // End ajax

            },
            hiddenChanged: function() {
                this.$.emailPanel._center();
            },
            clean: function () {
                this.subject = '';
                this.email = '';
                this.text = '';
                this.$.emailType.value = "suggest";
                this.message = "";
            },
            handleFeedback: function (e) {
                this.fire('feedbackend');
                this.$.emailPanel.hidden = false;
                this.$.emailPanel.style = "top: 60px;left: 500px";
                this.clean();
            }
        })
    </script>
</dom-module>
